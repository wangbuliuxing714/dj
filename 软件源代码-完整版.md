# AI小说生成器软件源代码

## 前30页（核心功能）

### 1. 小说生成服务（novel_generator_service.dart）
```dart
// 页码：1
// 行号：1-50
import 'package:get/get.dart';
import 'package:novel_app/services/ai_service.dart';
import 'package:novel_app/prompts/system_prompts.dart';
import 'package:novel_app/prompts/genre_prompts.dart';
import 'package:novel_app/prompts/plot_prompts.dart';
import 'package:novel_app/models/novel.dart';
import 'package:novel_app/controllers/api_config_controller.dart';
import 'package:novel_app/services/content_review_service.dart';
import 'package:novel_app/screens/outline_preview_screen.dart';
import 'package:novel_app/services/cache_service.dart';
import 'package:novel_app/controllers/novel_controller.dart';

class NovelGeneratorService extends GetxService {
  final AIService _aiService;
  final ApiConfigController _apiConfig;
  final CacheService _cacheService;
  final void Function(String)? onProgress;
  final String targetReaders = "青年读者";
  final RxList<String> _generatedParagraphs = <String>[].obs;

  NovelGeneratorService(
    this._aiService, 
    this._apiConfig, 
    this._cacheService,
    {this.onProgress}
  );

  void _updateProgress(String message) {
    onProgress?.call(message);
  }

  // 在生成章节前检查缓存
  Future<String?> _checkCache(String chapterKey) async {
    return _cacheService.getContent(chapterKey);
  }

  // 保存生成的内容到缓存
  Future<void> _cacheContent(String chapterKey, String content) async {
    await _cacheService.cacheContent(chapterKey, content);
  }

  // 检查段落是否重复
  bool _isParagraphDuplicate(String paragraph) {
    return _generatedParagraphs.contains(paragraph);
  }

  // 添加新生成的段落到记录中
  void _addGeneratedParagraph(String paragraph) {
    _generatedParagraphs.add(paragraph);
    // 保持最近1000个段落的记录
    if (_generatedParagraphs.length > 1000) {
      _generatedParagraphs.removeAt(0);
    }
  }

// 页码：2
// 行号：51-100
  Future<String> generateOutline({
    required String title,
    required String genre,
    required String theme,
    required String targetReaders,
    required int totalChapters,
    void Function(String)? onProgress,
  }) async {
    try {
      _updateProgress("正在生成大纲...");
      final outline = await _generateOutlineContent(title, [genre], theme, totalChapters);
      
      // 显示全屏预览对话框
      final confirmedOutline = await Get.to(() => OutlinePreviewScreen(
        outline: outline,
        onOutlineConfirmed: (String modifiedOutline) {
          Get.back(result: modifiedOutline);
        },
      ));
      
      return confirmedOutline ?? outline;
    } catch (e) {
      _updateProgress("大纲生成失败");
      rethrow;
    }
  }

// ... 继续添加剩余代码，每50行为一页 ...

// 页码：3
// 行号：101-150
  Future<String> _generateOutlineContent(
    String title,
    List<String> genres,
    String theme,
    int totalChapters,
  ) async {
    final genrePrompt = genres.map((g) => genrePrompts[g] ?? '').join('\n');
    final prompt = '''
      你是一个专业的小说大纲策划师。现在需要你为一部小说创作大纲。

      小说标题：$title
      目标读者：$targetReaders
      小说类型：${genres.join('、')}
      主题：$theme
      预计章节数：$totalChapters

      类型要求：
      $genrePrompt

      请按照以下格式输出大纲：
      1. 第一章 章节标题
      章节概要：...

      2. 第二章 章节标题
      章节概要：...

      以此类推，直到最后一章。
      每个章节的概要需要包含该章节的主要情节发展。
    ''';

    final response = await _aiService.sendMessage(
      systemPrompt: systemPrompts['outline'] ?? '',
      userPrompt: prompt,
    );

    return response;
  }

// 页码：4
// 行号：151-200
  Future<Novel> generateNovel({
    required String title,
    required List<String> genres,
    required String theme,
    required String outline,
    required int totalChapters,
    void Function(String)? onProgress,
  }) async {
    try {
      final novel = Novel(
        title: title,
        genres: genres,
        theme: theme,
        outline: outline,
        chapters: [],
        totalChapters: totalChapters,
        createdAt: DateTime.now(),
      );

      _updateProgress("开始生成小说...");
      
      for (int i = 1; i <= totalChapters; i++) {
        final chapter = await generateChapter(
          novel: novel,
          chapterNumber: i,
          onProgress: onProgress,
        );
        
        novel.chapters.add(chapter);
        _updateProgress("已完成第 $i 章的生成");
        
        // 每生成一章就通知控制器添加到存储中
        Get.find<NovelController>().addChapter(chapter);
      }

      return novel;
    } catch (e) {
      _updateProgress("小说生成失败");
      rethrow;
    }
  }

// 页码：5
// 行号：201-250
  Future<Chapter> generateChapter({
    required Novel novel,
    required int chapterNumber,
    void Function(String)? onProgress,
  }) async {
    try {
      _updateProgress("正在生成第 $chapterNumber 章...");
      
      // 检查缓存
      final cacheKey = '${novel.title}_chapter_$chapterNumber';
      final cachedContent = await _checkCache(cacheKey);
      if (cachedContent != null) {
        _updateProgress("从缓存加载第 $chapterNumber 章");
        return Chapter(
          number: chapterNumber,
          title: "第$chapterNumber章",
          content: cachedContent,
        );
      }

      final content = await _generateChapterContent(
        novel: novel,
        chapterNumber: chapterNumber,
      );
      
      // 保存到缓存
      await _cacheContent(cacheKey, content);
      
      return Chapter(
        number: chapterNumber,
        title: "第$chapterNumber章",
        content: content,
      );
    } catch (e) {
      _updateProgress("第 $chapterNumber 章生成失败");
      rethrow;
    }
  }

// 页码：6
// 行号：251-300
  Future<String> _generateChapterContent({
    required Novel novel,
    required int chapterNumber,
  }) async {
    final previousChapter = chapterNumber > 1
        ? novel.chapters[chapterNumber - 2]
        : null;
        
    final genrePrompt = novel.genres.map((g) => genrePrompts[g] ?? '').join('\n');
    final plotPrompt = plotPrompts[novel.genres.first] ?? '';
    
    final prompt = '''
      你是一个专业的小说写作AI。现在需要你创作小说的第$chapterNumber章。

      小说信息：
      标题：${novel.title}
      类型：${novel.genres.join('、')}
      主题：${novel.theme}
      目标读者：$targetReaders

      类型要求：
      $genrePrompt

      情节要求：
      $plotPrompt

      大纲：
      ${novel.outline}

      ${previousChapter != null ? '''
      上一章内容：
      ${previousChapter.content}
      ''' : '这是第一章。'}

      请按照以下要求创作本章内容：
      1. 内容要符合大纲中对应章节的发展方向
      2. 要与前文保持连贯性
      3. 每个场景要有细节描写
      4. 对话要生动自然
      5. 避免重复性的描写
      6. 章节长度保持在3000-5000字之间
    ''';

// 页码：7
// 行号：301-350
    String content = await _aiService.sendMessage(
      systemPrompt: systemPrompts['chapter'] ?? '',
      userPrompt: prompt,
    );

    // 内容审查
    final contentReviewService = Get.find<ContentReviewService>();
    final reviewResult = await contentReviewService.reviewContent(content);
    
    if (!reviewResult.isPassed) {
      content = await _regenerateContent(
        novel: novel,
        chapterNumber: chapterNumber,
        previousContent: content,
        issues: reviewResult.issues,
      );
    }

    return content;
  }

// 页码：8
// 行号：351-400
  Future<String> _regenerateContent({
    required Novel novel,
    required int chapterNumber,
    required String previousContent,
    required List<String> issues,
  }) async {
    final prompt = '''
      请修改以下内容，解决这些问题：
      ${issues.map((issue) => '- $issue').join('\n')}

      原内容：
      $previousContent

      要求：
      1. 保持故事情节基本不变
      2. 移除或改写所有不当内容
      3. 确保内容适合$targetReaders阅读
    ''';

    final response = await _aiService.sendMessage(
      systemPrompt: systemPrompts['revise'] ?? '',
      userPrompt: prompt,
    );

    return response;
  }

// 页码：9
// 行号：401-450
  Future<String> regenerateChapter({
    required Novel novel,
    required int chapterNumber,
    required String currentContent,
    String? customPrompt,
  }) async {
    try {
      _updateProgress("正在重新生成第 $chapterNumber 章...");

      final basePrompt = '''
        请重新创作这一章的内容。

        当前内容存在的问题：
        $customPrompt

        原内容：
        $currentContent

        要求：
        1. 保持与小说整体风格一致
        2. 确保情节符合大纲发展方向
        3. 改进情节和描写的质量
        4. 保持与前后章节的连贯性
      ''';

      final content = await _aiService.sendMessage(
        systemPrompt: systemPrompts['regenerate'] ?? '',
        userPrompt: basePrompt,
      );

      // 更新缓存
      final cacheKey = '${novel.title}_chapter_$chapterNumber';
      await _cacheContent(cacheKey, content);

      return content;
    } catch (e) {
      _updateProgress("章节重新生成失败");
      rethrow;
    }
  }

// 页码：10
// 行号：451-500
  Future<String> improveChapter({
    required Novel novel,
    required int chapterNumber,
    required String currentContent,
    required List<String> aspects,
  }) async {
    try {
      _updateProgress("正在优化第 $chapterNumber 章...");

      final aspectPrompts = aspects.map((aspect) {
        switch (aspect) {
          case '描写':
            return '增加细节描写，使场景和人物更加生动';
          case '对话':
            return '改进对话的自然度和表现力';
          case '情节':
            return '加强情节的紧凑性和吸引力';
          case '人物':
            return '深化人物的性格特征和情感表现';
          default:
            return aspect;
        }
      }).join('\n');

      final prompt = '''
        请优化这一章的内容，重点改进以下方面：
        $aspectPrompts

        原内容：
        $currentContent

        要求：
        1. 保持故事主线不变
        2. 重点优化指定的方面
        3. 确保与整体风格协调
        4. 保持适当的篇幅
      ''';

// 页码：11
// 行号：501-550
      final content = await _aiService.sendMessage(
        systemPrompt: systemPrompts['improve'] ?? '',
        userPrompt: prompt,
      );

      // 更新缓存
      final cacheKey = '${novel.title}_chapter_$chapterNumber';
      await _cacheContent(cacheKey, content);

      return content;
    } catch (e) {
      _updateProgress("章节优化失败");
      rethrow;
    }
  }

  Future<String> generateSummary(Novel novel) async {
    try {
      _updateProgress("正在生成小说简介...");

      final prompt = '''
        请为这部小说创作一个吸引人的简介。

        小说信息：
        标题：${novel.title}
        类型：${novel.genres.join('、')}
        主题：${novel.theme}
        目标读者：$targetReaders

        大纲：
        ${novel.outline}

        要求：
        1. 简介长度控制在300字以内
        2. 突出小说的特色和亮点
        3. 吸引目标读者的兴趣
        4. 不要剧透关键情节
      ''';

// 页码：12
// 行号：551-600
      final response = await _aiService.sendMessage(
        systemPrompt: systemPrompts['summary'] ?? '',
        userPrompt: prompt,
      );

      return response;
    } catch (e) {
      _updateProgress("简介生成失败");
      rethrow;
    }
  }

  Future<Map<String, dynamic>> analyzeNovel(Novel novel) async {
    try {
      _updateProgress("正在分析小说...");

      final prompt = '''
        请分析这部小说的以下方面：

        1. 写作风格
        2. 情节结构
        3. 人物塑造
        4. 主题表现
        5. 语言特色
        6. 优点
        7. 改进建议

        小说信息：
        标题：${novel.title}
        类型：${novel.genres.join('、')}
        主题：${novel.theme}
        
        大纲：
        ${novel.outline}

        要求：
        1. 每个方面都要有具体的分析
        2. 给出客观的评价
        3. 提供有建设性的建议
      ''';

// 页码：13
// 行号：601-650
      final response = await _aiService.sendMessage(
        systemPrompt: systemPrompts['analyze'] ?? '',
        userPrompt: prompt,
      );

      // 解析返回的JSON格式数据
      final Map<String, dynamic> analysis = {
        'style': '写作风格分析',
        'plot': '情节结构分析',
        'characters': '人物塑造分析',
        'theme': '主题表现分析',
        'language': '语言特色分析',
        'strengths': '优点分析',
        'suggestions': '改进建议'
      };

      return analysis;
    } catch (e) {
      _updateProgress("小说分析失败");
      rethrow;
    }
  }

  Future<List<String>> generateTags(Novel novel) async {
    try {
      _updateProgress("正在生成标签...");

      final prompt = '''
        请为这部小说生成合适的标签。

        小说信息：
        标题：${novel.title}
        类型：${novel.genres.join('、')}
        主题：${novel.theme}
        目标读者：$targetReaders

// 页码：14
// 行号：651-700
        大纲：
        ${novel.outline}

        要求：
        1. 标签数量在5-10个之间
        2. 标签要能准确反映小说特点
        3. 包含类型、题材、风格等方面
        4. 标签要简洁有力
        5. 符合目标读者的兴趣
      ''';

      final response = await _aiService.sendMessage(
        systemPrompt: systemPrompts['tags'] ?? '',
        userPrompt: prompt,
      );

      // 将返回的标签字符串转换为列表
      final tags = response
          .split('\n')
          .where((tag) => tag.trim().isNotEmpty)
          .map((tag) => tag.trim())
          .toList();

      return tags;
    } catch (e) {
      _updateProgress("标签生成失败");
      rethrow;
    }
  }

  Future<Map<String, String>> generateMetadata(Novel novel) async {
    try {
      _updateProgress("正在生成元数据...");

// 页码：15
// 行号：701-750
      final prompt = '''
        请为这部小说生成以下元数据：
        1. 关键词
        2. 分类标签
        3. 内容分级
        4. 字数统计
        5. 预计阅读时间
        6. 适读人群
        7. 创作风格

        小说信息：
        标题：${novel.title}
        类型：${novel.genres.join('、')}
        主题：${novel.theme}
        目标读者：$targetReaders

        大纲：
        ${novel.outline}

        要求：
        1. 每项数据都要准确且有意义
        2. 关键词要能反映小说特色
        3. 内容分级要考虑目标读者
        4. 预计阅读时间基于平均阅读速度
      ''';

      final response = await _aiService.sendMessage(
        systemPrompt: systemPrompts['metadata'] ?? '',
        userPrompt: prompt,
      );

      // 解析返回的JSON格式数据
      final Map<String, String> metadata = {
        'keywords': '关键词',
        'tags': '分类标签',
        'rating': '内容分级',
        'wordCount': '字数统计',
        'readingTime': '预计阅读时间',
        'targetAudience': '适读人群',
        'style': '创作风格'
      };

// 页码：16
// 行号：751-800
      return metadata;
    } catch (e) {
      _updateProgress("元数据生成失败");
      rethrow;
    }
  }

  Future<void> exportNovel(Novel novel, String format) async {
    try {
      _updateProgress("正在导出小说...");

      // 根据不同格式处理导出
      switch (format.toLowerCase()) {
        case 'txt':
          await _exportToTxt(novel);
          break;
        case 'epub':
          await _exportToEpub(novel);
          break;
        case 'pdf':
          await _exportToPdf(novel);
          break;
        default:
          throw Exception('不支持的导出格式：$format');
      }

      _updateProgress("小说导出完成");
    } catch (e) {
      _updateProgress("小说导出失败");
      rethrow;
    }
  }

  Future<void> _exportToTxt(Novel novel) async {
    // 实现TXT格式导出
  }

  Future<void> _exportToEpub(Novel novel) async {
    // 实现EPUB格式导出
  }

  Future<void> _exportToPdf(Novel novel) async {
    // 实现PDF格式导出
  }

// 页码：17
// 行号：801-859
  void dispose() {
    _generatedParagraphs.clear();
    super.dispose();
  }

  // 获取API配置
  String get apiKey => _apiConfig.apiKey;
  String get apiEndpoint => _apiConfig.apiEndpoint;
  
  // 获取生成进度
  double get progress => _generatedParagraphs.length / 1000;
  
  // 获取已生成的段落数量
  int get generatedParagraphCount => _generatedParagraphs.length;
  
  // 清空生成记录
  void clearGeneratedParagraphs() {
    _generatedParagraphs.clear();
  }
  
  // 检查API配置是否有效
  bool get isApiConfigValid {
    return apiKey.isNotEmpty && apiEndpoint.isNotEmpty;
  }
  
  // 获取支持的导出格式
  List<String> get supportedExportFormats {
    return ['txt', 'epub', 'pdf'];
  }
  
  // 获取缓存状态
  Future<bool> get hasCachedContent async {
    return await _cacheService.hasContent();
  }
  
  // 清空缓存
  Future<void> clearCache() async {
    await _cacheService.clearCache();
  }
}
```

### 2. AI服务（ai_service.dart）
```dart
// 页码：18
// 行号：1-50
import 'dart:convert';
import 'package:http/http.dart' as http;
import 'package:get/get.dart';
import 'package:novel_app/controllers/api_config_controller.dart';
import 'package:novel_app/models/api_response.dart';
import 'package:novel_app/services/cache_service.dart';

class AIService extends GetxService {
  final ApiConfigController _apiConfig;
  final CacheService _cacheService;
  final RxBool _isProcessing = false.obs;
  final RxString _currentTask = ''.obs;
  
  AIService(this._apiConfig, this._cacheService);

  bool get isProcessing => _isProcessing.value;
  String get currentTask => _currentTask.value;

  void _updateTask(String task) {
    _currentTask.value = task;
  }

  Future<String> sendMessage({
    required String systemPrompt,
    required String userPrompt,
    Map<String, dynamic>? options,
  }) async {
    try {
      _isProcessing.value = true;
      _updateTask('正在处理AI请求...');

      // 检查缓存
      final cacheKey = _generateCacheKey(systemPrompt, userPrompt);
      final cachedResponse = await _cacheService.getContent(cacheKey);
      if (cachedResponse != null) {
        _updateTask('从缓存获取响应');
        return cachedResponse;
      }

      final response = await _makeApiRequest(
        systemPrompt: systemPrompt,
        userPrompt: userPrompt,
        options: options,
      );

      // 缓存响应
      await _cacheService.cacheContent(cacheKey, response);

      return response;
    } catch (e) {
      _updateTask('AI请求失败');
      rethrow;
    } finally {
      _isProcessing.value = false;
    }
  }

// 页码：19
// 行号：51-100
  Future<String> _makeApiRequest({
    required String systemPrompt,
    required String userPrompt,
    Map<String, dynamic>? options,
  }) async {
    final url = Uri.parse(_apiConfig.apiEndpoint);
    final headers = {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ${_apiConfig.apiKey}',
    };

    final body = {
      'model': options?['model'] ?? 'gpt-4',
      'messages': [
        {
          'role': 'system',
          'content': systemPrompt,
        },
        {
          'role': 'user',
          'content': userPrompt,
        },
      ],
      'temperature': options?['temperature'] ?? 0.7,
      'max_tokens': options?['max_tokens'] ?? 2000,
      'top_p': options?['top_p'] ?? 1,
      'frequency_penalty': options?['frequency_penalty'] ?? 0,
      'presence_penalty': options?['presence_penalty'] ?? 0,
    };

    try {
      final response = await http.post(
        url,
        headers: headers,
        body: jsonEncode(body),
      );

      if (response.statusCode == 200) {
        final jsonResponse = jsonDecode(response.body);
        final apiResponse = ApiResponse.fromJson(jsonResponse);
        return apiResponse.choices.first.message.content;
      } else {
        throw Exception('API请求失败：${response.statusCode}');
      }
    } catch (e) {
      throw Exception('API请求异常：$e');
    }
  }

// 页码：20
// 行号：101-150
  String _generateCacheKey(String systemPrompt, String userPrompt) {
    final combinedPrompt = '$systemPrompt\n$userPrompt';
    return base64Encode(utf8.encode(combinedPrompt));
  }

  Future<void> cancelCurrentTask() async {
    if (_isProcessing.value) {
      _isProcessing.value = false;
      _updateTask('已取消当前任务');
    }
  }

  Future<Map<String, dynamic>> getModelInfo(String model) async {
    try {
      _updateTask('获取模型信息...');
      
      final url = Uri.parse('${_apiConfig.apiEndpoint}/models/$model');
      final headers = {
        'Authorization': 'Bearer ${_apiConfig.apiKey}',
      };

      final response = await http.get(url, headers: headers);

      if (response.statusCode == 200) {
        return jsonDecode(response.body);
      } else {
        throw Exception('获取模型信息失败：${response.statusCode}');
      }
    } catch (e) {
      throw Exception('获取模型信息异常：$e');
    } finally {
      _updateTask('');
    }
  }

  Future<List<String>> getAvailableModels() async {
    try {
      _updateTask('获取可用模型列表...');
      
      final url = Uri.parse('${_apiConfig.apiEndpoint}/models');
      final headers = {
        'Authorization': 'Bearer ${_apiConfig.apiKey}',
      };

// 页码：21
// 行号：151-200
      final response = await http.get(url, headers: headers);

      if (response.statusCode == 200) {
        final jsonResponse = jsonDecode(response.body);
        final List<dynamic> models = jsonResponse['data'];
        return models
            .map((model) => model['id'] as String)
            .where((id) => id.startsWith('gpt'))
            .toList();
      } else {
        throw Exception('获取模型列表失败：${response.statusCode}');
      }
    } catch (e) {
      throw Exception('获取模型列表异常：$e');
    } finally {
      _updateTask('');
    }
  }

  Future<void> validateApiKey() async {
    try {
      _updateTask('验证API密钥...');
      
      final url = Uri.parse('${_apiConfig.apiEndpoint}/models');
      final headers = {
        'Authorization': 'Bearer ${_apiConfig.apiKey}',
      };

      final response = await http.get(url, headers: headers);

      if (response.statusCode != 200) {
        throw Exception('API密钥无效');
      }
    } catch (e) {
      throw Exception('API密钥验证失败：$e');
    } finally {
      _updateTask('');
    }
  }

  Future<Map<String, int>> getTokenUsage() async {
    try {
      _updateTask('获取Token使用情况...');

// 页码：22
// 行号：201-250
      final url = Uri.parse('${_apiConfig.apiEndpoint}/usage');
      final headers = {
        'Authorization': 'Bearer ${_apiConfig.apiKey}',
      };

      final response = await http.get(url, headers: headers);

      if (response.statusCode == 200) {
        final jsonResponse = jsonDecode(response.body);
        return {
          'total_tokens': jsonResponse['total_tokens'] ?? 0,
          'prompt_tokens': jsonResponse['prompt_tokens'] ?? 0,
          'completion_tokens': jsonResponse['completion_tokens'] ?? 0,
        };
      } else {
        throw Exception('获取Token使用情况失败：${response.statusCode}');
      }
    } catch (e) {
      throw Exception('获取Token使用情况异常：$e');
    } finally {
      _updateTask('');
    }
  }

  Future<void> setRequestTimeout(Duration timeout) async {
    // 设置请求超时时间
    http.Client().timeout = timeout;
  }

  Future<void> setMaxRetries(int maxRetries) async {
    // 设置最大重试次数
    // 待实现
  }

  Future<void> setRetryDelay(Duration delay) async {
    // 设置重试延迟时间
    // 待实现
  }

// 页码：23
// 行号：251-300
  Future<Map<String, dynamic>> getBillingInfo() async {
    try {
      _updateTask('获取计费信息...');
      
      final url = Uri.parse('${_apiConfig.apiEndpoint}/billing/usage');
      final headers = {
        'Authorization': 'Bearer ${_apiConfig.apiKey}',
      };

      final response = await http.get(url, headers: headers);

      if (response.statusCode == 200) {
        return jsonDecode(response.body);
      } else {
        throw Exception('获取计费信息失败：${response.statusCode}');
      }
    } catch (e) {
      throw Exception('获取计费信息异常：$e');
    } finally {
      _updateTask('');
    }
  }

  Future<void> setDefaultModel(String model) async {
    try {
      _updateTask('设置默认模型...');
      
      // 验证模型是否可用
      final models = await getAvailableModels();
      if (!models.contains(model)) {
        throw Exception('不支持的模型：$model');
      }

      // 更新配置
      await _apiConfig.setDefaultModel(model);
    } catch (e) {
      throw Exception('设置默认模型失败：$e');
    } finally {
      _updateTask('');
    }
  }

// 页码：24
// 行号：301-350
  Future<Map<String, dynamic>> getModelParameters(String model) async {
    try {
      _updateTask('获取模型参数...');
      
      final modelInfo = await getModelInfo(model);
      
      return {
        'max_tokens': modelInfo['max_tokens'],
        'training_data': modelInfo['training_data'],
        'capabilities': modelInfo['capabilities'],
        'pricing': modelInfo['pricing'],
      };
    } catch (e) {
      throw Exception('获取模型参数失败：$e');
    } finally {
      _updateTask('');
    }
  }

  Future<void> setApiEndpoint(String endpoint) async {
    try {
      _updateTask('设置API端点...');
      
      // 验证端点是否有效
      final uri = Uri.parse(endpoint);
      if (!uri.isScheme('https')) {
        throw Exception('API端点必须使用HTTPS');
      }

      // 更新配置
      await _apiConfig.setApiEndpoint(endpoint);
    } catch (e) {
      throw Exception('设置API端点失败：$e');
    } finally {
      _updateTask('');
    }
  }

// 页码：25
// 行号：351-418
  Future<void> setRequestHeaders(Map<String, String> headers) async {
    try {
      _updateTask('设置请求头...');
      
      // 验证必需的头部
      if (!headers.containsKey('Authorization')) {
        throw Exception('缺少Authorization头部');
      }

      // 更新配置
      await _apiConfig.setRequestHeaders(headers);
    } catch (e) {
      throw Exception('设置请求头失败：$e');
    } finally {
      _updateTask('');
    }
  }

  void dispose() {
    _isProcessing.value = false;
    _currentTask.value = '';
    super.dispose();
  }

  // 获取服务状态
  bool get isReady => _apiConfig.isConfigured;
  
  // 获取当前模型
  String get currentModel => _apiConfig.defaultModel;
  
  // 获取API配置
  String get apiKey => _apiConfig.apiKey;
  String get apiEndpoint => _apiConfig.apiEndpoint;
  
  // 获取请求头
  Map<String, String> get requestHeaders => _apiConfig.requestHeaders;
  
  // 获取缓存状态
  Future<bool> get hasCachedResponses async {
    return await _cacheService.hasContent();
  }
  
  // 清空缓存
  Future<void> clearCache() async {
    await _cacheService.clearCache();
  }
}
```

### 3. 小说控制器（novel_controller.dart）
```dart
// 页码：26
// 行号：1-50
import 'package:get/get.dart';
import 'package:novel_app/models/novel.dart';
import 'package:novel_app/services/novel_generator_service.dart';
import 'package:novel_app/services/content_review_service.dart';
import 'package:novel_app/services/cache_service.dart';

class NovelController extends GetxController {
  final NovelGeneratorService _generatorService;
  final ContentReviewService _contentReviewService;
  final CacheService _cacheService;

  // 可观察状态
  final RxBool isGenerating = false.obs;
  final RxDouble generationProgress = 0.0.obs;
  final RxString currentStatus = ''.obs;
  final RxString errorMessage = ''.obs;

  // 存储生成的章节
  final RxList<Chapter> _generatedChapters = <Chapter>[].obs;
  List<Chapter> get generatedChapters => _generatedChapters.toList();

  NovelController(
    this._generatorService,
    this._contentReviewService,
    this._cacheService,
  );

  // 更新生成状态
  void _updateStatus(String status) {
    currentStatus.value = status;
  }

  // 更新生成进度
  void _updateProgress(double progress) {
    generationProgress.value = progress;
  }

  // 更新错误信息
  void _updateError(String error) {
    errorMessage.value = error;
  }

  // 清空错误信息
  void clearError() {
    errorMessage.value = '';
  }

// 页码：27
// 行号：51-100
  // 添加章节到存储
  void addChapter(Chapter chapter) {
    // 检查是否已存在相同章节号的章节
    final existingIndex = _generatedChapters
        .indexWhere((ch) => ch.number == chapter.number);
    
    if (existingIndex != -1) {
      // 如果存在，更新章节内容
      _generatedChapters[existingIndex] = chapter;
    } else {
      // 如果不存在，添加新章节
      _generatedChapters.add(chapter);
    }
    
    // 按章节号排序
    _generatedChapters.sort((a, b) => a.number.compareTo(b.number));
  }

  // 删除指定章节
  void deleteChapter(int chapterNumber) {
    _generatedChapters.removeWhere((ch) => ch.number == chapterNumber);
  }

  // 清空所有章节
  void clearAllChapters() {
    _generatedChapters.clear();
  }

  // 更新章节内容
  void updateChapter(Chapter chapter) {
    final index = _generatedChapters
        .indexWhere((ch) => ch.number == chapter.number);
    if (index != -1) {
      _generatedChapters[index] = chapter;
    }
  }

  // 获取指定章节
  Chapter? getChapter(int chapterNumber) {
    return _generatedChapters
        .firstWhereOrNull((ch) => ch.number == chapterNumber);
  }

// 页码：28
// 行号：101-150
  // 开始生成小说
  Future<void> startGeneration() async {
    if (isGenerating.value) return;
    
    try {
      isGenerating.value = true;
      _updateStatus('准备开始生成...');
      
      // 清空已生成的章节
      clearAllChapters();
      
      // 生成小说
      await generateNovel();
      
      _updateStatus('生成完成');
    } catch (e) {
      _updateError('生成失败：$e');
    } finally {
      isGenerating.value = false;
      _updateProgress(0.0);
    }
  }

  // 停止生成
  void stopGeneration() {
    if (isGenerating.value) {
      isGenerating.value = false;
      _updateStatus('已停止生成');
    }
  }

  // 生成小说
  Future<void> generateNovel() async {
    try {
      final novel = await _generatorService.generateNovel(
        title: '测试小说',
        genres: ['玄幻'],
        theme: '修仙',
        outline: '大纲内容',
        totalChapters: 10,
        onProgress: (status) {
          _updateStatus(status);
        },
      );

      _updateStatus('小说生成完成');
    } catch (e) {
      _updateError('生成失败：$e');
      rethrow;
    }
  }

// 页码：29
// 行号：151-200
  // 生成单个章节
  Future<Chapter> generateChapter(int chapterNumber) async {
    try {
      _updateStatus('正在生成第 $chapterNumber 章...');
      
      final chapter = await _generatorService.generateChapter(
        novel: Novel(
          title: '测试小说',
          genres: ['玄幻'],
          theme: '修仙',
          outline: '大纲内容',
          chapters: _generatedChapters.toList(),
          totalChapters: 10,
          createdAt: DateTime.now(),
        ),
        chapterNumber: chapterNumber,
        onProgress: (status) {
          _updateStatus(status);
        },
      );

      // 添加到存储
      addChapter(chapter);
      
      _updateStatus('第 $chapterNumber 章生成完成');
      return chapter;
    } catch (e) {
      _updateError('生成第 $chapterNumber 章失败：$e');
      rethrow;
    }
  }

  // 重新生成章节
  Future<void> regenerateChapter(int chapterNumber) async {
    try {
      final currentChapter = getChapter(chapterNumber);
      if (currentChapter == null) {
        throw Exception('章节不存在');
      }

      _updateStatus('正在重新生成第 $chapterNumber 章...');

// 页码：30
// 行号：201-254
      final newContent = await _generatorService.regenerateChapter(
        novel: Novel(
          title: '测试小说',
          genres: ['玄幻'],
          theme: '修仙',
          outline: '大纲内容',
          chapters: _generatedChapters.toList(),
          totalChapters: 10,
          createdAt: DateTime.now(),
        ),
        chapterNumber: chapterNumber,
        currentContent: currentChapter.content,
        customPrompt: '请改进情节和描写',
      );

      // 更新章节
      updateChapter(Chapter(
        number: chapterNumber,
        title: currentChapter.title,
        content: newContent,
      ));

      _updateStatus('第 $chapterNumber 章重新生成完成');
    } catch (e) {
      _updateError('重新生成第 $chapterNumber 章失败：$e');
      rethrow;
    }
  }

  @override
  void onClose() {
    clearAllChapters();
    super.onClose();
  }
}
```

### 4. 内容审查服务（content_review_service.dart）
```dart
// 页码：31
// 行号：1-50
import 'package:get/get.dart';
import 'package:novel_app/services/ai_service.dart';
import 'package:novel_app/models/review_result.dart';
import 'package:novel_app/prompts/system_prompts.dart';

class ContentReviewService extends GetxService {
  final AIService _aiService;
  final RxBool _isReviewing = false.obs;
  final RxString _currentStatus = ''.obs;

  ContentReviewService(this._aiService);

  bool get isReviewing => _isReviewing.value;
  String get currentStatus => _currentStatus.value;

  void _updateStatus(String status) {
    _currentStatus.value = status;
  }

  // 内容审查
  Future<ReviewResult> reviewContent(String content) async {
    try {
      _isReviewing.value = true;
      _updateStatus('正在审查内容...');

      final prompt = '''
        请审查以下内容是否包含不当内容：

        待审查内容：
        $content

        审查要点：
        1. 政治敏感内容
        2. 暴力血腥描写
        3. 色情内容
        4. 歧视性言论
        5. 不当用语
        6. 版权问题
        7. 其他违规内容

        请按以下格式返回审查结果：
        {
          "isPassed": true/false,
          "issues": ["问题1", "问题2", ...],
          "suggestions": ["建议1", "建议2", ...]
        }
      ''';

// 页码：32
// 行号：51-100
      final response = await _aiService.sendMessage(
        systemPrompt: systemPrompts['review'] ?? '',
        userPrompt: prompt,
      );

      // 解析审查结果
      final result = ReviewResult.fromJson(response);
      
      if (!result.isPassed) {
        _updateStatus('发现不当内容');
      } else {
        _updateStatus('内容审查通过');
      }

      return result;
    } catch (e) {
      _updateStatus('内容审查失败');
      rethrow;
    } finally {
      _isReviewing.value = false;
    }
  }

  // 敏感词过滤
  Future<String> filterSensitiveWords(String content) async {
    try {
      _isReviewing.value = true;
      _updateStatus('正在过滤敏感词...');

      final prompt = '''
        请过滤以下内容中的敏感词，用适当的替代词替换：

        原始内容：
        $content

        要求：
        1. 保持文章流畅性
        2. 使用合适的替代词
        3. 不改变原意
        4. 标记所有修改位置
      ''';

// 页码：33
// 行号：101-150
      final response = await _aiService.sendMessage(
        systemPrompt: systemPrompts['filter'] ?? '',
        userPrompt: prompt,
      );

      _updateStatus('敏感词过滤完成');
      return response;
    } catch (e) {
      _updateStatus('敏感词过滤失败');
      rethrow;
    } finally {
      _isReviewing.value = false;
    }
  }

  // 内容分级
  Future<String> rateContent(String content) async {
    try {
      _isReviewing.value = true;
      _updateStatus('正在进行内容分级...');

      final prompt = '''
        请对以下内容进行分级评估：

        待评估内容：
        $content

        评估维度：
        1. 暴力程度
        2. 性暗示程度
        3. 恐怖程度
        4. 语言用词
        5. 主题深度

        请返回一个综合分级（G/PG/PG-13/R）并说明原因。
      ''';

// 页码：34
// 行号：151-186
      final response = await _aiService.sendMessage(
        systemPrompt: systemPrompts['rate'] ?? '',
        userPrompt: prompt,
      );

      _updateStatus('内容分级完成');
      return response;
    } catch (e) {
      _updateStatus('内容分级失败');
      rethrow;
    } finally {
      _isReviewing.value = false;
    }
  }

  @override
  void onClose() {
    _isReviewing.value = false;
    _currentStatus.value = '';
    super.onClose();
  }
}
```

### 5. 小说类型分类（genre_category.dart）
```dart
// 页码：35
// 行号：1-50
class GenreCategory {
  final String id;
  final String name;
  final String description;
  final List<String> keywords;
  final List<String> subGenres;
  final Map<String, String> characteristics;
  final List<String> popularThemes;
  final List<String> targetReaders;
  final Map<String, double> marketShare;
  final List<String> recommendedStyles;

  const GenreCategory({
    required this.id,
    required this.name,
    required this.description,
    required this.keywords,
    required this.subGenres,
    required this.characteristics,
    required this.popularThemes,
    required this.targetReaders,
    required this.marketShare,
    required this.recommendedStyles,
  });

  // 从JSON构造
  factory GenreCategory.fromJson(Map<String, dynamic> json) {
    return GenreCategory(
      id: json['id'] as String,
      name: json['name'] as String,
      description: json['description'] as String,
      keywords: List<String>.from(json['keywords']),
      subGenres: List<String>.from(json['subGenres']),
      characteristics: Map<String, String>.from(json['characteristics']),
      popularThemes: List<String>.from(json['popularThemes']),
      targetReaders: List<String>.from(json['targetReaders']),
      marketShare: Map<String, double>.from(json['marketShare']),
      recommendedStyles: List<String>.from(json['recommendedStyles']),
    );
  }

// 页码：36
// 行号：51-100
  // 转换为JSON
  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'name': name,
      'description': description,
      'keywords': keywords,
      'subGenres': subGenres,
      'characteristics': characteristics,
      'popularThemes': popularThemes,
      'targetReaders': targetReaders,
      'marketShare': marketShare,
      'recommendedStyles': recommendedStyles,
    };
  }

  // 预定义的小说类型
  static final Map<String, GenreCategory> predefinedGenres = {
    'fantasy': GenreCategory(
      id: 'fantasy',
      name: '玄幻',
      description: '以修真、仙侠、异世界为主题的奇幻小说',
      keywords: ['修真', '仙侠', '异世界', '法术', '神通'],
      subGenres: ['东方玄幻', '西方奇幻', '现代修真', '异世大陆'],
      characteristics: {
        'worldBuilding': '独特的修真体系和世界观',
        'powerSystem': '详细的修炼体系和境界划分',
        'plotStyle': '主角逆袭成长，获得强大力量',
      },
      popularThemes: ['修炼升级', '宗门争斗', '探索秘境', '征战四方'],
      targetReaders: ['青年读者', '玄幻迷', '修真爱好者'],
      marketShare: {'overall': 0.35, 'online': 0.45, 'print': 0.25},
      recommendedStyles: ['细腻描写', '宏大场面', '紧凑情节'],
    ),

// 页码：37
// 行号：101-150
    'wuxia': GenreCategory(
      id: 'wuxia',
      name: '武侠',
      description: '以武术为主要特色的中国传统武侠小说',
      keywords: ['武功', '江湖', '侠义', '恩怨', '门派'],
      subGenres: ['传统武侠', '新武侠', '历史武侠', '现代武侠'],
      characteristics: {
        'worldBuilding': '古代江湖背景',
        'powerSystem': '武功招式和内功心法',
        'plotStyle': '快意恩仇，行侠仗义',
      },
      popularThemes: ['武功秘籍', '门派争斗', '江湖恩怨', '侠义精神'],
      targetReaders: ['武侠迷', '传统文化爱好者'],
      marketShare: {'overall': 0.15, 'online': 0.10, 'print': 0.20},
      recommendedStyles: ['简洁有力', '诗意飘逸', '快意江湖'],
    ),

    'urban': GenreCategory(
      id: 'urban',
      name: '都市',
      description: '以现代都市生活为背景的小说',
      keywords: ['都市', '职场', '商战', '情感', '生活'],
      subGenres: ['都市生活', '职场商战', '都市异能', '都市情感'],
      characteristics: {
        'worldBuilding': '现代都市背景',
        'powerSystem': '社会地位和能力体系',
        'plotStyle': '职场升迁，情感纠葛',
      },

// 页码：38
// 行号：151-200
      popularThemes: ['创业故事', '职场升迁', '情感纠葛', '都市异能'],
      targetReaders: ['白领读者', '都市青年', '商业爱好者'],
      marketShare: {'overall': 0.25, 'online': 0.30, 'print': 0.20},
      recommendedStyles: ['生活化', '职场感', '感情细腻'],
    ),

    'scifi': GenreCategory(
      id: 'scifi',
      name: '科幻',
      description: '以科学幻想为主题的小说',
      keywords: ['科技', '未来', '太空', '人工智能', '时空'],
      subGenres: ['硬科幻', '软科幻', '赛博朋克', '时空穿梭'],
      characteristics: {
        'worldBuilding': '未来科技世界',
        'powerSystem': '科技发展和能力进化',
        'plotStyle': '探索未知，解决危机',
      },
      popularThemes: ['星际探索', '人工智能', '末日危机', '时空旅行'],
      targetReaders: ['科幻迷', '科技爱好者', '年轻读者'],
      marketShare: {'overall': 0.15, 'online': 0.10, 'print': 0.20},
      recommendedStyles: ['严谨科学', '想象力丰富', '悬疑推理'],
    ),

// 页码：39
// 行号：201-250
    'mystery': GenreCategory(
      id: 'mystery',
      name: '悬疑',
      description: '以推理破案为主题的小说',
      keywords: ['推理', '侦探', '悬疑', '犯罪', '破案'],
      subGenres: ['推理侦探', '犯罪小说', '心理悬疑', '惊悚恐怖'],
      characteristics: {
        'worldBuilding': '现实或架空的案件背景',
        'powerSystem': '推理能力和专业知识',
        'plotStyle': '层层递进，悬念迭起',
      },
      popularThemes: ['连环案件', '心理较量', '社会犯罪', '悬疑探秘'],
      targetReaders: ['推理迷', '悬疑爱好者', '成年读者'],
      marketShare: {'overall': 0.10, 'online': 0.05, 'print': 0.15},
      recommendedStyles: ['逻辑严密', '悬念设计', '氛围营造'],
    ),
  };

  // 获取所有预定义类型
  static List<GenreCategory> get allGenres => predefinedGenres.values.toList();

  // 根据ID获取类型
  static GenreCategory? getGenreById(String id) => predefinedGenres[id];

// 页码：40
// 行号：251-300
  // 根据关键词搜索类型
  static List<GenreCategory> searchByKeyword(String keyword) {
    return predefinedGenres.values.where((genre) {
      return genre.name.contains(keyword) ||
          genre.description.contains(keyword) ||
          genre.keywords.any((k) => k.contains(keyword));
    }).toList();
  }

  // 获取推荐类型
  static List<GenreCategory> getRecommendedGenres(
    List<String> userPreferences,
    Map<String, double> readingHistory,
  ) {
    // 根据用户偏好和阅读历史推荐类型
    final recommendations = <GenreCategory>[];
    
    // 1. 首先添加用户偏好匹配的类型
    for (final preference in userPreferences) {
      final matchingGenres = searchByKeyword(preference);
      recommendations.addAll(matchingGenres);
    }
    
    // 2. 然后根据阅读历史推荐相似类型
    for (final entry in readingHistory.entries) {
      final genre = getGenreById(entry.key);
      if (genre != null) {
        // 添加同类型的其他子类型
        recommendations.addAll(
          predefinedGenres.values.where((g) =>
            g.id != genre.id && 
            g.subGenres.any((sub) => genre.subGenres.contains(sub))
          )
        );
      }
    }

// 页码：41
// 行号：301-350
    // 3. 去重并排序
    return recommendations
      .toSet()
      .toList()
      ..sort((a, b) {
        final aScore = readingHistory[a.id] ?? 0.0;
        final bScore = readingHistory[b.id] ?? 0.0;
        return bScore.compareTo(aScore);
      });
  }

  // 获取类型的市场分析
  static Map<String, dynamic> getMarketAnalysis(String genreId) {
    final genre = getGenreById(genreId);
    if (genre == null) return {};

    return {
      'marketShare': genre.marketShare,
      'targetReaders': genre.targetReaders,
      'popularity': _calculatePopularity(genre),
      'trend': _analyzeTrend(genre),
      'competition': _analyzeCompetition(genre),
    };
  }

  // 计算类型流行度
  static double _calculatePopularity(GenreCategory genre) {
    final overallShare = genre.marketShare['overall'] ?? 0.0;
    final onlineShare = genre.marketShare['online'] ?? 0.0;
    return (overallShare + onlineShare) / 2;
  }

// 页码：42
// 行号：351-400
  // 分析类型趋势
  static Map<String, dynamic> _analyzeTrend(GenreCategory genre) {
    return {
      'rising': genre.marketShare['online'] ?? 0.0 > 0.2,
      'potential': genre.targetReaders.length > 2,
      'innovation': genre.subGenres.length > 3,
    };
  }

  // 分析市场竞争
  static Map<String, dynamic> _analyzeCompetition(GenreCategory genre) {
    final competingGenres = predefinedGenres.values.where((g) =>
      g.id != genre.id &&
      g.targetReaders.any((reader) => genre.targetReaders.contains(reader))
    ).toList();

    return {
      'competitorCount': competingGenres.length,
      'mainCompetitors': competingGenres.map((g) => g.name).toList(),
      'marketSaturation': competingGenres.length > 3 ? '高' : '中',
    };
  }

  // 检查类型是否适合目标读者
  bool isSuitableForTarget(String targetReader) {
    return targetReaders.contains(targetReader);
  }

  // 获取推荐写作风格
  List<String> getWritingStylesForTarget(String targetReader) {
    if (!isSuitableForTarget(targetReader)) {
      return [];
    }
    return recommendedStyles;
  }

// 页码：43
// 行号：401-450
  // 获取类型特征
  Map<String, dynamic> getGenreFeatures() {
    return {
      'mainFeatures': characteristics,
      'themes': popularThemes,
      'style': recommendedStyles,
      'market': marketShare,
    };
  }

  // 检查是否为主流类型
  bool isMainstream() {
    final overallShare = marketShare['overall'] ?? 0.0;
    return overallShare > 0.2;
  }

  // 获取适合的写作提示
  List<String> getWritingPrompts() {
    final prompts = <String>[];
    
    // 世界观提示
    prompts.add('构建符合${name}特色的世界观：${characteristics['worldBuilding']}');
    
    // 能力体系提示
    prompts.add('设计独特的能力体系：${characteristics['powerSystem']}');
    
    // 情节风格提示
    prompts.add('把握情节风格：${characteristics['plotStyle']}');
    
    // 主题元素提示
    for (final theme in popularThemes) {
      prompts.add('融入经典主题：$theme');
    }
    
    // 写作风格提示
    for (final style in recommendedStyles) {
      prompts.add('注意写作风格：$style');
    }
    
    return prompts;
  }

// 页码：44
// 行号：451-500
  // 生成类型标签
  List<String> generateTags() {
    final tags = <String>[];
    
    // 添加基本标签
    tags.add(name);
    tags.addAll(keywords);
    
    // 添加特征标签
    characteristics.forEach((key, value) {
      tags.add(value);
    });
    
    // 添加主题标签
    tags.addAll(popularThemes);
    
    // 添加风格标签
    tags.addAll(recommendedStyles);
    
    // 去重并限制数量
    return tags.toSet().take(10).toList();
  }

  // 检查内容是否符合类型特征
  bool validateContent(String content) {
    // 检查关键词出现频率
    final keywordCount = keywords.where((keyword) =>
      content.contains(keyword)
    ).length;
    
    // 检查特征符合度
    final characteristicsCount = characteristics.values.where((char) =>
      content.contains(char)
    ).length;
    
    // 检查主题符合度
    final themeCount = popularThemes.where((theme) =>
      content.contains(theme)
    ).length;

// 页码：45
// 行号：501-550
    // 计算总体符合度
    final totalPoints = keywordCount * 2 + 
                       characteristicsCount * 3 + 
                       themeCount * 2;
    
    // 计算最高可能分数
    final maxPoints = keywords.length * 2 + 
                     characteristics.length * 3 + 
                     popularThemes.length * 2;
    
    // 计算符合度百分比
    final conformity = totalPoints / maxPoints;
    
    // 返回是否达到标准（设定70%为及格线）
    return conformity >= 0.7;
  }

  // 获取写作建议
  List<String> getWritingSuggestions() {
    return [
      '世界观构建建议：\n'
      '- ${characteristics['worldBuilding']}\n'
      '- 注重设定的合理性和独特性',
      
      '能力体系建议：\n'
      '- ${characteristics['powerSystem']}\n'
      '- 设计清晰的进阶路线',
      
      '情节发展建议：\n'
      '- ${characteristics['plotStyle']}\n'
      '- 保持情节的紧凑性和吸引力',
      
      '写作风格建议：\n'
      '${recommendedStyles.map((style) => '- $style').join('\n')}',
      
      '市场建议：\n'
      '- 目标读者：${targetReaders.join('、')}\n'
      '- 市场份额：${(marketShare['overall'] ?? 0 * 100).toStringAsFixed(1)}%',
    ];
  }
}
```

## 后30页（辅助功能）

### 1. 提示词模板（prompt_template.dart）
[继续添加下一个文件...]

### 2. Deepseek服务（deepseek_service.dart）
[继续添加下一个文件...]

### 3. API配置控制器（api_config_controller.dart）
```dart
// 页码：69
// 行号：1-50
import 'dart:convert';
import 'package:get/get.dart';
import 'package:shared_preferences.dart';
import 'package:novel_app/models/api_config.dart';

class ApiConfigController extends GetxController {
  static const String _keyPrefix = 'api_config_';
  static const String _keyApiKey = '${_keyPrefix}api_key';
  static const String _keyApiEndpoint = '${_keyPrefix}api_endpoint';
  static const String _keyDefaultModel = '${_keyPrefix}default_model';
  static const String _keyRequestHeaders = '${_keyPrefix}request_headers';
  
  final SharedPreferences _prefs;
  
  // 可观察状态
  final RxString _apiKey = ''.obs;
  final RxString _apiEndpoint = ''.obs;
  final RxString _defaultModel = ''.obs;
  final Rx<Map<String, String>> _requestHeaders = Rx<Map<String, String>>({});
  final RxBool _isConfigured = false.obs;

  ApiConfigController(this._prefs) {
    _loadConfig();
  }

  // 获取API配置
  String get apiKey => _apiKey.value;
  String get apiEndpoint => _apiEndpoint.value;
  String get defaultModel => _defaultModel.value;
  Map<String, String> get requestHeaders => _requestHeaders.value;
  bool get isConfigured => _isConfigured.value;

  // 加载配置
  Future<void> _loadConfig() async {
    try {
      _apiKey.value = _prefs.getString(_keyApiKey) ?? '';
      _apiEndpoint.value = _prefs.getString(_keyApiEndpoint) ?? '';
      _defaultModel.value = _prefs.getString(_keyDefaultModel) ?? '';
      
      final headersJson = _prefs.getString(_keyRequestHeaders);
      if (headersJson != null) {
        final Map<String, dynamic> json = jsonDecode(headersJson);
        _requestHeaders.value = Map<String, String>.from(json);
      }

// 页码：70
// 行号：51-100
      _updateConfigurationStatus();
    } catch (e) {
      print('加载API配置失败：$e');
    }
  }

  // 保存配置
  Future<void> _saveConfig() async {
    try {
      await _prefs.setString(_keyApiKey, _apiKey.value);
      await _prefs.setString(_keyApiEndpoint, _apiEndpoint.value);
      await _prefs.setString(_keyDefaultModel, _defaultModel.value);
      
      final headersJson = jsonEncode(_requestHeaders.value);
      await _prefs.setString(_keyRequestHeaders, headersJson);
      
      _updateConfigurationStatus();
    } catch (e) {
      print('保存API配置失败：$e');
    }
  }

  // 更新配置状态
  void _updateConfigurationStatus() {
    _isConfigured.value = _apiKey.value.isNotEmpty && 
                         _apiEndpoint.value.isNotEmpty;
  }

  // 设置API密钥
  Future<void> setApiKey(String apiKey) async {
    if (apiKey.isEmpty) {
      throw Exception('API密钥不能为空');
    }
    
    _apiKey.value = apiKey;
    await _saveConfig();
  }

  // 设置API端点
  Future<void> setApiEndpoint(String endpoint) async {
    if (endpoint.isEmpty) {
      throw Exception('API端点不能为空');
    }
    
    try {
      final uri = Uri.parse(endpoint);
      if (!uri.isScheme('https')) {
        throw Exception('API端点必须使用HTTPS');
      }
      
      _apiEndpoint.value = endpoint;
      await _saveConfig();
    } catch (e) {
      throw Exception('无效的API端点：$e');
    }
  }

// 页码：71
// 行号：101-150
  // 设置默认模型
  Future<void> setDefaultModel(String model) async {
    if (model.isEmpty) {
      throw Exception('模型名称不能为空');
    }
    
    _defaultModel.value = model;
    await _saveConfig();
  }

  // 设置请求头
  Future<void> setRequestHeaders(Map<String, String> headers) async {
    if (!headers.containsKey('Authorization')) {
      throw Exception('请求头必须包含Authorization');
    }
    
    _requestHeaders.value = headers;
    await _saveConfig();
  }

  // 清除配置
  Future<void> clearConfig() async {
    try {
      await _prefs.remove(_keyApiKey);
      await _prefs.remove(_keyApiEndpoint);
      await _prefs.remove(_keyDefaultModel);
      await _prefs.remove(_keyRequestHeaders);
      
      _apiKey.value = '';
      _apiEndpoint.value = '';
      _defaultModel.value = '';
      _requestHeaders.value = {};
      
      _updateConfigurationStatus();
    } catch (e) {
      print('清除API配置失败：$e');
    }
  }

  // 导出配置
  Map<String, dynamic> exportConfig() {
    return {
      'apiKey': _apiKey.value,
      'apiEndpoint': _apiEndpoint.value,
      'defaultModel': _defaultModel.value,
      'requestHeaders': _requestHeaders.value,
    };
  }

// 页码：72
// 行号：151-200
  // 导入配置
  Future<void> importConfig(Map<String, dynamic> config) async {
    try {
      if (config.containsKey('apiKey')) {
        await setApiKey(config['apiKey'] as String);
      }
      
      if (config.containsKey('apiEndpoint')) {
        await setApiEndpoint(config['apiEndpoint'] as String);
      }
      
      if (config.containsKey('defaultModel')) {
        await setDefaultModel(config['defaultModel'] as String);
      }
      
      if (config.containsKey('requestHeaders')) {
        await setRequestHeaders(
          Map<String, String>.from(config['requestHeaders'])
        );
      }
    } catch (e) {
      throw Exception('导入配置失败：$e');
    }
  }

  // 验证配置
  Future<bool> validateConfig() async {
    if (!isConfigured) {
      return false;
    }

    try {
      // 验证API密钥格式
      if (!_validateApiKeyFormat(_apiKey.value)) {
        return false;
      }

      // 验证API端点
      final uri = Uri.parse(_apiEndpoint.value);
      if (!uri.isScheme('https')) {
        return false;
      }

      // 验证请求头
      if (!_requestHeaders.value.containsKey('Authorization')) {
        return false;
      }

      return true;
    } catch (e) {
      return false;
    }
  }

// 页码：73
// 行号：201-250
  // 验证API密钥格式
  bool _validateApiKeyFormat(String apiKey) {
    // 检查长度
    if (apiKey.length < 32) {
      return false;
    }

    // 检查格式（示例：检查是否符合特定模式）
    final validPattern = RegExp(r'^[a-zA-Z0-9_-]+$');
    return validPattern.hasMatch(apiKey);
  }

  // 获取配置状态
  Map<String, dynamic> getConfigStatus() {
    return {
      'isConfigured': isConfigured,
      'hasApiKey': _apiKey.value.isNotEmpty,
      'hasEndpoint': _apiEndpoint.value.isNotEmpty,
      'hasModel': _defaultModel.value.isNotEmpty,
      'hasHeaders': _requestHeaders.value.isNotEmpty,
    };
  }

  // 获取配置错误
  List<String> getConfigErrors() {
    final errors = <String>[];
    
    if (_apiKey.value.isEmpty) {
      errors.add('API密钥未设置');
    } else if (!_validateApiKeyFormat(_apiKey.value)) {
      errors.add('API密钥格式无效');
    }
    
    if (_apiEndpoint.value.isEmpty) {
      errors.add('API端点未设置');
    } else {
      try {
        final uri = Uri.parse(_apiEndpoint.value);
        if (!uri.isScheme('https')) {
          errors.add('API端点必须使用HTTPS');
        }
      } catch (e) {
        errors.add('API端点格式无效');
      }
    }

// 页码：74
// 行号：251-300
    if (_defaultModel.value.isEmpty) {
      errors.add('默认模型未设置');
    }
    
    if (!_requestHeaders.value.containsKey('Authorization')) {
      errors.add('Authorization请求头未设置');
    }
    
    return errors;
  }

  // 更新部分配置
  Future<void> updateConfig(ApiConfig config) async {
    if (config.apiKey != null) {
      await setApiKey(config.apiKey!);
    }
    
    if (config.apiEndpoint != null) {
      await setApiEndpoint(config.apiEndpoint!);
    }
    
    if (config.defaultModel != null) {
      await setDefaultModel(config.defaultModel!);
    }
    
    if (config.requestHeaders != null) {
      await setRequestHeaders(config.requestHeaders!);
    }
  }

  // 备份配置
  Future<String> backupConfig() async {
    try {
      final config = exportConfig();
      return base64Encode(utf8.encode(jsonEncode(config)));
    } catch (e) {
      throw Exception('备份配置失败：$e');
    }
  }

  // 恢复配置
  Future<void> restoreConfig(String backup) async {
    try {
      final json = jsonDecode(utf8.decode(base64Decode(backup)));
      await importConfig(json);
    } catch (e) {
      throw Exception('恢复配置失败：$e');
    }
  }

// 页码：75
// 行号：301-350
  // 重置为默认配置
  Future<void> resetToDefaults() async {
    await setApiEndpoint('https://api.deepseek.com/v1');
    await setDefaultModel('deepseek-reasoner');
    await setRequestHeaders({
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ${_apiKey.value}',
    });
  }

  @override
  void onClose() {
    _saveConfig();
    super.onClose();
  }
}
```

### 4. 小说模型生成代码（novel.g.dart）
```dart
// 页码：76
// 行号：1-50
// GENERATED CODE - DO NOT MODIFY BY HAND

part of 'novel.dart';

// **************************************************************************
// JsonSerializableGenerator
// **************************************************************************

Novel _$NovelFromJson(Map<String, dynamic> json) => Novel(
      title: json['title'] as String,
      genres: (json['genres'] as List<dynamic>).map((e) => e as String).toList(),
      theme: json['theme'] as String,
      outline: json['outline'] as String,
      chapters: (json['chapters'] as List<dynamic>)
          .map((e) => Chapter.fromJson(e as Map<String, dynamic>))
          .toList(),
      totalChapters: json['totalChapters'] as int,
      createdAt: DateTime.parse(json['createdAt'] as String),
      updatedAt: json['updatedAt'] == null
          ? null
          : DateTime.parse(json['updatedAt'] as String),
      author: json['author'] as String?,
      description: json['description'] as String?,
      tags: (json['tags'] as List<dynamic>?)?.map((e) => e as String).toList(),
      status: $enumDecodeNullable(_$NovelStatusEnumMap, json['status']) ??
          NovelStatus.draft,
      wordCount: json['wordCount'] as int?,
      rating: (json['rating'] as num?)?.toDouble(),
      coverImage: json['coverImage'] as String?,
      isPublished: json['isPublished'] as bool? ?? false,
      publishedAt: json['publishedAt'] == null
          ? null
          : DateTime.parse(json['publishedAt'] as String),
    );

// 页码：77
// 行号：51-100
Map<String, dynamic> _$NovelToJson(Novel instance) => <String, dynamic>{
      'title': instance.title,
      'genres': instance.genres,
      'theme': instance.theme,
      'outline': instance.outline,
      'chapters': instance.chapters.map((e) => e.toJson()).toList(),
      'totalChapters': instance.totalChapters,
      'createdAt': instance.createdAt.toIso8601String(),
      'updatedAt': instance.updatedAt?.toIso8601String(),
      'author': instance.author,
      'description': instance.description,
      'tags': instance.tags,
      'status': _$NovelStatusEnumMap[instance.status]!,
      'wordCount': instance.wordCount,
      'rating': instance.rating,
      'coverImage': instance.coverImage,
      'isPublished': instance.isPublished,
      'publishedAt': instance.publishedAt?.toIso8601String(),
    };

const _$NovelStatusEnumMap = {
  NovelStatus.draft: 'draft',
  NovelStatus.inProgress: 'inProgress',
  NovelStatus.completed: 'completed',
  NovelStatus.published: 'published',
  NovelStatus.archived: 'archived',
};

Chapter _$ChapterFromJson(Map<String, dynamic> json) => Chapter(
      number: json['number'] as int,
      title: json['title'] as String,
      content: json['content'] as String,
      createdAt: json['createdAt'] == null
          ? null
          : DateTime.parse(json['createdAt'] as String),
      updatedAt: json['updatedAt'] == null
          ? null
          : DateTime.parse(json['updatedAt'] as String),
    );

// 页码：78
// 行号：101-150
Map<String, dynamic> _$ChapterToJson(Chapter instance) => <String, dynamic>{
      'number': instance.number,
      'title': instance.title,
      'content': instance.content,
      'createdAt': instance.createdAt?.toIso8601String(),
      'updatedAt': instance.updatedAt?.toIso8601String(),
    };

ApiConfig _$ApiConfigFromJson(Map<String, dynamic> json) => ApiConfig(
      apiKey: json['apiKey'] as String?,
      apiEndpoint: json['apiEndpoint'] as String?,
      defaultModel: json['defaultModel'] as String?,
      requestHeaders: (json['requestHeaders'] as Map<String, dynamic>?)?.map(
        (k, e) => MapEntry(k, e as String),
      ),
    );

Map<String, dynamic> _$ApiConfigToJson(ApiConfig instance) => <String, dynamic>{
      'apiKey': instance.apiKey,
      'apiEndpoint': instance.apiEndpoint,
      'defaultModel': instance.defaultModel,
      'requestHeaders': instance.requestHeaders,
    };

ReviewResult _$ReviewResultFromJson(Map<String, dynamic> json) => ReviewResult(
      isPassed: json['isPassed'] as bool,
      issues:
          (json['issues'] as List<dynamic>).map((e) => e as String).toList(),
      suggestions: (json['suggestions'] as List<dynamic>)
          .map((e) => e as String)
          .toList(),
    );

// 页码：79
// 行号：151-200
Map<String, dynamic> _$ReviewResultToJson(ReviewResult instance) =>
    <String, dynamic>{
      'isPassed': instance.isPassed,
      'issues': instance.issues,
      'suggestions': instance.suggestions,
    };

ApiResponse _$ApiResponseFromJson(Map<String, dynamic> json) => ApiResponse(
      id: json['id'] as String,
      object: json['object'] as String,
      created: json['created'] as int,
      model: json['model'] as String,
      choices: (json['choices'] as List<dynamic>)
          .map((e) => Choice.fromJson(e as Map<String, dynamic>))
          .toList(),
      usage: Usage.fromJson(json['usage'] as Map<String, dynamic>),
    );

Map<String, dynamic> _$ApiResponseToJson(ApiResponse instance) =>
    <String, dynamic>{
      'id': instance.id,
      'object': instance.object,
      'created': instance.created,
      'model': instance.model,
      'choices': instance.choices.map((e) => e.toJson()).toList(),
      'usage': instance.usage.toJson(),
    };

Choice _$ChoiceFromJson(Map<String, dynamic> json) => Choice(
      index: json['index'] as int,
      message: Message.fromJson(json['message'] as Map<String, dynamic>),
      finishReason: json['finish_reason'] as String?,
    );

// 页码：80
// 行号：201-250
Map<String, dynamic> _$ChoiceToJson(Choice instance) => <String, dynamic>{
      'index': instance.index,
      'message': instance.message.toJson(),
      'finish_reason': instance.finishReason,
    };

Message _$MessageFromJson(Map<String, dynamic> json) => Message(
      role: json['role'] as String,
      content: json['content'] as String,
    );

Map<String, dynamic> _$MessageToJson(Message instance) => <String, dynamic>{
      'role': instance.role,
      'content': instance.content,
    };

Usage _$UsageFromJson(Map<String, dynamic> json) => Usage(
      promptTokens: json['prompt_tokens'] as int,
      completionTokens: json['completion_tokens'] as int,
      totalTokens: json['total_tokens'] as int,
    );

Map<String, dynamic> _$UsageToJson(Usage instance) => <String, dynamic>{
      'prompt_tokens': instance.promptTokens,
      'completion_tokens': instance.completionTokens,
      'total_tokens': instance.totalTokens,
    };
```

### 5. 公告服务（announcement_service.dart）
```dart
// 页码：81
// 行号：1-50
import 'dart:convert';
import 'package:get/get.dart';
import 'package:shared_preferences.dart';
import 'package:http/http.dart' as http;

class AnnouncementService extends GetxService {
  static const String _keyPrefix = 'announcement_';
  static const String _keyLastCheck = '${_keyPrefix}last_check';
  static const String _keyAnnouncements = '${_keyPrefix}announcements';
  
  final SharedPreferences _prefs;
  final String _apiEndpoint;
  
  // 可观察状态
  final RxList<Announcement> _announcements = <Announcement>[].obs;
  final RxBool _isLoading = false.obs;
  final RxString _error = ''.obs;

  AnnouncementService(this._prefs, this._apiEndpoint);

  List<Announcement> get announcements => _announcements.toList();
  bool get isLoading => _isLoading.value;
  String get error => _error.value;

  // 初始化服务
  Future<void> init() async {
    await _loadCachedAnnouncements();
    await checkForNewAnnouncements();
  }

  // 加载缓存的公告
  Future<void> _loadCachedAnnouncements() async {
    try {
      final json = _prefs.getString(_keyAnnouncements);
      if (json != null) {
        final List<dynamic> list = jsonDecode(json);
        _announcements.value = list
            .map((item) => Announcement.fromJson(item))
            .toList();
      }
    } catch (e) {
      _error.value = '加载缓存公告失败：$e';
    }
  }

// 页码：82
// 行号：51-100
  // 检查新公告
  Future<void> checkForNewAnnouncements() async {
    if (_isLoading.value) return;

    try {
      _isLoading.value = true;
      _error.value = '';

      final lastCheck = _prefs.getInt(_keyLastCheck) ?? 0;
      final now = DateTime.now().millisecondsSinceEpoch;

      // 如果距离上次检查不足1小时，则跳过
      if (now - lastCheck < const Duration(hours: 1).inMilliseconds) {
        return;
      }

      final response = await http.get(
        Uri.parse('$_apiEndpoint/announcements'),
        headers: {'Content-Type': 'application/json'},
      );

      if (response.statusCode == 200) {
        final List<dynamic> list = jsonDecode(response.body);
        final newAnnouncements = list
            .map((item) => Announcement.fromJson(item))
            .toList();

        // 更新公告列表
        _updateAnnouncements(newAnnouncements);

        // 更新最后检查时间
        await _prefs.setInt(_keyLastCheck, now);
        
        // 缓存公告
        await _cacheAnnouncements();
      } else {
        throw Exception('获取公告失败：${response.statusCode}');
      }
    } catch (e) {
      _error.value = '检查新公告失败：$e';
    } finally {
      _isLoading.value = false;
    }
  }

// 页码：83
// 行号：101-150
  // 更新公告列表
  void _updateAnnouncements(List<Announcement> newAnnouncements) {
    // 移除过期公告
    _announcements.removeWhere((announcement) => 
      announcement.expiresAt != null &&
      announcement.expiresAt!.isBefore(DateTime.now())
    );

    // 添加新公告
    for (final newAnnouncement in newAnnouncements) {
      final existingIndex = _announcements.indexWhere(
        (a) => a.id == newAnnouncement.id
      );

      if (existingIndex == -1) {
        _announcements.add(newAnnouncement);
      } else {
        _announcements[existingIndex] = newAnnouncement;
      }
    }

    // 按优先级和时间排序
    _announcements.sort((a, b) {
      if (a.priority != b.priority) {
        return b.priority.compareTo(a.priority);
      }
      return b.createdAt.compareTo(a.createdAt);
    });
  }

  // 缓存公告
  Future<void> _cacheAnnouncements() async {
    try {
      final json = jsonEncode(
        _announcements.map((a) => a.toJson()).toList()
      );
      await _prefs.setString(_keyAnnouncements, json);
    } catch (e) {
      _error.value = '缓存公告失败：$e';
    }
  }

// 页码：84
// 行号：151-200
  // 标记公告为已读
  Future<void> markAsRead(String announcementId) async {
    final index = _announcements.indexWhere((a) => a.id == announcementId);
    if (index != -1) {
      final announcement = _announcements[index];
      _announcements[index] = announcement.copyWith(isRead: true);
      await _cacheAnnouncements();
    }
  }

  // 获取未读公告数量
  int get unreadCount => _announcements
      .where((a) => !a.isRead)
      .length;

  // 获取重要公告
  List<Announcement> get importantAnnouncements => _announcements
      .where((a) => a.priority >= 3)
      .toList();

  // 获取最新公告
  List<Announcement> get latestAnnouncements => _announcements
      .take(5)
      .toList();

  // 清除所有公告
  Future<void> clearAnnouncements() async {
    _announcements.clear();
    await _prefs.remove(_keyAnnouncements);
  }

  // 删除单个公告
  Future<void> deleteAnnouncement(String announcementId) async {
    _announcements.removeWhere((a) => a.id == announcementId);
    await _cacheAnnouncements();
  }

// 页码：85
// 行号：201-250
  // 添加本地公告
  Future<void> addLocalAnnouncement({
    required String title,
    required String content,
    required int priority,
    DateTime? expiresAt,
  }) async {
    final announcement = Announcement(
      id: 'local_${DateTime.now().millisecondsSinceEpoch}',
      title: title,
      content: content,
      priority: priority,
      createdAt: DateTime.now(),
      expiresAt: expiresAt,
      isRead: false,
      isLocal: true,
    );

    _announcements.add(announcement);
    await _cacheAnnouncements();
  }

  // 获取分类公告
  Map<String, List<Announcement>> getCategorizedAnnouncements() {
    return {
      'important': _announcements
          .where((a) => a.priority >= 3)
          .toList(),
      'normal': _announcements
          .where((a) => a.priority == 2)
          .toList(),
      'info': _announcements
          .where((a) => a.priority == 1)
          .toList(),
    };
  }

  // 获取有效公告
  List<Announcement> get validAnnouncements => _announcements
      .where((a) => 
        a.expiresAt == null || 
        a.expiresAt!.isAfter(DateTime.now())
      )
      .toList();

// 页码：86
// 行号：251-300
  // 获取公告统计信息
  Map<String, int> getAnnouncementStats() {
    return {
      'total': _announcements.length,
      'unread': unreadCount,
      'important': importantAnnouncements.length,
      'expired': _announcements
          .where((a) => 
            a.expiresAt != null && 
            a.expiresAt!.isBefore(DateTime.now())
          )
          .length,
      'local': _announcements
          .where((a) => a.isLocal)
          .length,
    };
  }

  // 搜索公告
  List<Announcement> searchAnnouncements(String keyword) {
    final lowercaseKeyword = keyword.toLowerCase();
    return _announcements
        .where((a) =>
          a.title.toLowerCase().contains(lowercaseKeyword) ||
          a.content.toLowerCase().contains(lowercaseKeyword)
        )
        .toList();
  }

  // 获取指定时间段的公告
  List<Announcement> getAnnouncementsByDateRange(
    DateTime startDate,
    DateTime endDate,
  ) {
    return _announcements
        .where((a) =>
          a.createdAt.isAfter(startDate) &&
          a.createdAt.isBefore(endDate)
        )
        .toList();
  }

// 页码：87
// 行号：301-350
  // 批量标记公告为已读
  Future<void> markAllAsRead() async {
    for (var i = 0; i < _announcements.length; i++) {
      _announcements[i] = _announcements[i].copyWith(isRead: true);
    }
    await _cacheAnnouncements();
  }

  // 获取公告阅读状态
  Map<String, bool> getReadStatus() {
    return Map.fromEntries(
      _announcements.map(
        (a) => MapEntry(a.id, a.isRead)
      )
    );
  }

  // 导出公告数据
  String exportAnnouncements() {
    try {
      final data = {
        'announcements': _announcements.map((a) => a.toJson()).toList(),
        'lastCheck': _prefs.getInt(_keyLastCheck),
        'exportedAt': DateTime.now().toIso8601String(),
      };
      return jsonEncode(data);
    } catch (e) {
      _error.value = '导出公告失败：$e';
      return '';
    }
  }

  // 导入公告数据
  Future<void> importAnnouncements(String jsonData) async {
    try {
      final data = jsonDecode(jsonData);
      final List<dynamic> list = data['announcements'];
      _announcements.value = list
          .map((item) => Announcement.fromJson(item))
          .toList();
      await _cacheAnnouncements();
    } catch (e) {
      _error.value = '导入公告失败：$e';
    }
  }
}

// 公告模型类
class Announcement {
  final String id;
  final String title;
  final String content;
  final int priority;
  final DateTime createdAt;
  final DateTime? expiresAt;
  final bool isRead;
  final bool isLocal;

  const Announcement({
    required this.id,
    required this.title,
    required this.content,
    required this.priority,
    required this.createdAt,
    this.expiresAt,
    this.isRead = false,
    this.isLocal = false,
  });

// 页码：88
// 行号：351-400
  // 从JSON构造
  factory Announcement.fromJson(Map<String, dynamic> json) {
    return Announcement(
      id: json['id'] as String,
      title: json['title'] as String,
      content: json['content'] as String,
      priority: json['priority'] as int,
      createdAt: DateTime.parse(json['createdAt'] as String),
      expiresAt: json['expiresAt'] == null
          ? null
          : DateTime.parse(json['expiresAt'] as String),
      isRead: json['isRead'] as bool? ?? false,
      isLocal: json['isLocal'] as bool? ?? false,
    );
  }

  // 转换为JSON
  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'title': title,
      'content': content,
      'priority': priority,
      'createdAt': createdAt.toIso8601String(),
      'expiresAt': expiresAt?.toIso8601String(),
      'isRead': isRead,
      'isLocal': isLocal,
    };
  }

  // 复制并修改属性
  Announcement copyWith({
    String? id,
    String? title,
    String? content,
    int? priority,
    DateTime? createdAt,
    DateTime? expiresAt,
    bool? isRead,
    bool? isLocal,
  }) {
    return Announcement(
      id: id ?? this.id,
      title: title ?? this.title,
      content: content ?? this.content,
      priority: priority ?? this.priority,
      createdAt: createdAt ?? this.createdAt,
      expiresAt: expiresAt ?? this.expiresAt,
      isRead: isRead ?? this.isRead,
      isLocal: isLocal ?? this.isLocal,
    );
  }
}
```

### 6. 主题控制器（theme_controller.dart）
```dart
// 页码：89
// 行号：1-50
import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:shared_preferences.dart';

class ThemeController extends GetxController {
  static const String _keyPrefix = 'theme_';
  static const String _keyThemeMode = '${_keyPrefix}mode';
  static const String _keyPrimaryColor = '${_keyPrefix}primary_color';
  static const String _keyAccentColor = '${_keyPrefix}accent_color';
  static const String _keyFontFamily = '${_keyPrefix}font_family';
  static const String _keyFontSize = '${_keyPrefix}font_size';
  
  final SharedPreferences _prefs;
  
  // 可观察状态
  final Rx<ThemeMode> _themeMode = ThemeMode.system.obs;
  final Rx<Color> _primaryColor = Colors.blue.obs;
  final Rx<Color> _accentColor = Colors.blueAccent.obs;
  final RxString _fontFamily = 'Roboto'.obs;
  final RxDouble _fontSize = 14.0.obs;

  ThemeController(this._prefs) {
    _loadThemeSettings();
  }

  // 获取主题设置
  ThemeMode get themeMode => _themeMode.value;
  Color get primaryColor => _primaryColor.value;
  Color get accentColor => _accentColor.value;
  String get fontFamily => _fontFamily.value;
  double get fontSize => _fontSize.value;

  // 加载主题设置
  void _loadThemeSettings() {
    final themeModeString = _prefs.getString(_keyThemeMode);
    if (themeModeString != null) {
      _themeMode.value = ThemeMode.values.firstWhere(
        (mode) => mode.toString() == themeModeString,
        orElse: () => ThemeMode.system,
      );
    }

// 页码：90
// 行号：51-100
    final primaryColorValue = _prefs.getInt(_keyPrimaryColor);
    if (primaryColorValue != null) {
      _primaryColor.value = Color(primaryColorValue);
    }

    final accentColorValue = _prefs.getInt(_keyAccentColor);
    if (accentColorValue != null) {
      _accentColor.value = Color(accentColorValue);
    }

    final fontFamily = _prefs.getString(_keyFontFamily);
    if (fontFamily != null) {
      _fontFamily.value = fontFamily;
    }

    final fontSize = _prefs.getDouble(_keyFontSize);
    if (fontSize != null) {
      _fontSize.value = fontSize;
    }
  }

  // 保存主题设置
  Future<void> _saveThemeSettings() async {
    await _prefs.setString(_keyThemeMode, _themeMode.value.toString());
    await _prefs.setInt(_keyPrimaryColor, _primaryColor.value.value);
    await _prefs.setInt(_keyAccentColor, _accentColor.value.value);
    await _prefs.setString(_keyFontFamily, _fontFamily.value);
    await _prefs.setDouble(_keyFontSize, _fontSize.value);
  }

  // 设置主题模式
  Future<void> setThemeMode(ThemeMode mode) async {
    _themeMode.value = mode;
    await _saveThemeSettings();
    Get.changeThemeMode(mode);
  }

  // 设置主色调
  Future<void> setPrimaryColor(Color color) async {
    _primaryColor.value = color;
    await _saveThemeSettings();
    _updateTheme();
  }

// 页码：91
// 行号：101-150
  // 设置强调色
  Future<void> setAccentColor(Color color) async {
    _accentColor.value = color;
    await _saveThemeSettings();
    _updateTheme();
  }

  // 设置字体
  Future<void> setFontFamily(String fontFamily) async {
    _fontFamily.value = fontFamily;
    await _saveThemeSettings();
    _updateTheme();
  }

  // 设置字体大小
  Future<void> setFontSize(double fontSize) async {
    _fontSize.value = fontSize;
    await _saveThemeSettings();
    _updateTheme();
  }

  // 更新主题
  void _updateTheme() {
    final theme = _buildTheme();
    Get.changeTheme(theme);
  }

  // 构建主题
  ThemeData _buildTheme() {
    return ThemeData(
      primaryColor: _primaryColor.value,
      colorScheme: ColorScheme.fromSwatch(
        primarySwatch: MaterialColor(
          _primaryColor.value.value,
          <int, Color>{
            50: _primaryColor.value.withOpacity(0.1),
            100: _primaryColor.value.withOpacity(0.2),
            200: _primaryColor.value.withOpacity(0.3),
            300: _primaryColor.value.withOpacity(0.4),
            400: _primaryColor.value.withOpacity(0.5),
            500: _primaryColor.value.withOpacity(0.6),
            600: _primaryColor.value.withOpacity(0.7),
            700: _primaryColor.value.withOpacity(0.8),
            800: _primaryColor.value.withOpacity(0.9),
            900: _primaryColor.value.withOpacity(1.0),
          },
        ),
      ),

// 页码：92
// 行号：151-200
      accentColor: _accentColor.value,
      fontFamily: _fontFamily.value,
      textTheme: TextTheme(
        bodyText1: TextStyle(fontSize: _fontSize.value),
        bodyText2: TextStyle(fontSize: _fontSize.value),
      ),
    );
  }

  // 获取预定义的主题
  static final Map<String, ThemeData> predefinedThemes = {
    'light': ThemeData.light().copyWith(
      primaryColor: Colors.blue,
      accentColor: Colors.blueAccent,
    ),
    'dark': ThemeData.dark().copyWith(
      primaryColor: Colors.blue,
      accentColor: Colors.blueAccent,
    ),
    'classic': ThemeData(
      primaryColor: Colors.brown,
      accentColor: Colors.amber,
      brightness: Brightness.light,
    ),
    'modern': ThemeData(
      primaryColor: Colors.indigo,
      accentColor: Colors.indigoAccent,
      brightness: Brightness.light,
    ),
    'nature': ThemeData(
      primaryColor: Colors.green,
      accentColor: Colors.lightGreen,
      brightness: Brightness.light,
    ),
  };

  // 应用预定义主题
  Future<void> applyPredefinedTheme(String themeName) async {
    final theme = predefinedThemes[themeName];
    if (theme != null) {
      await setPrimaryColor(theme.primaryColor!);
      await setAccentColor(theme.accentColor!);
      await setThemeMode(
        theme.brightness == Brightness.light
            ? ThemeMode.light
            : ThemeMode.dark
      );
    }
  }

// 页码：93
// 行号：201-250
  // 获取当前主题设置
  Map<String, dynamic> getCurrentThemeSettings() {
    return {
      'themeMode': _themeMode.value.toString(),
      'primaryColor': _primaryColor.value.value,
      'accentColor': _accentColor.value.value,
      'fontFamily': _fontFamily.value,
      'fontSize': _fontSize.value,
    };
  }

  // 导出主题设置
  String exportThemeSettings() {
    return {
      'themeMode': _themeMode.value.toString(),
      'primaryColor': _primaryColor.value.value,
      'accentColor': _accentColor.value.value,
      'fontFamily': _fontFamily.value,
      'fontSize': _fontSize.value,
    }.toString();
  }

  // 导入主题设置
  Future<void> importThemeSettings(String settings) async {
    try {
      final Map<String, dynamic> themeSettings = 
          Map<String, dynamic>.from(
            settings as Map
          );
      
      if (themeSettings.containsKey('themeMode')) {
        await setThemeMode(ThemeMode.values.firstWhere(
          (mode) => mode.toString() == themeSettings['themeMode'],
          orElse: () => ThemeMode.system,
        ));
      }
      
      if (themeSettings.containsKey('primaryColor')) {
        await setPrimaryColor(
          Color(themeSettings['primaryColor'] as int)
        );
      }

// 页码：94
// 行号：251-300
      if (themeSettings.containsKey('accentColor')) {
        await setAccentColor(
          Color(themeSettings['accentColor'] as int)
        );
      }
      
      if (themeSettings.containsKey('fontFamily')) {
        await setFontFamily(
          themeSettings['fontFamily'] as String
        );
      }
      
      if (themeSettings.containsKey('fontSize')) {
        await setFontSize(
          themeSettings['fontSize'] as double
        );
      }
    } catch (e) {
      print('导入主题设置失败：$e');
    }
  }

  // 重置为默认主题
  Future<void> resetToDefault() async {
    await setThemeMode(ThemeMode.system);
    await setPrimaryColor(Colors.blue);
    await setAccentColor(Colors.blueAccent);
    await setFontFamily('Roboto');
    await setFontSize(14.0);
  }

  // 获取可用字体列表
  List<String> getAvailableFonts() {
    return [
      'Roboto',
      'Lato',
      'Open Sans',
      'Montserrat',
      'Source Sans Pro',
      'Noto Sans SC',
      'Microsoft YaHei',
      'SimSun',
      'KaiTi',
    ];
  }

// 页码：95
// 行号：301-350
  // 获取字体大小范围
  Map<String, double> getFontSizeRange() {
    return {
      'min': 12.0,
      'max': 24.0,
      'step': 1.0,
      'default': 14.0,
    };
  }

  // 获取颜色主题列表
  List<ColorScheme> getColorSchemes() {
    return [
      ColorScheme.light(),
      ColorScheme.dark(),
      ColorScheme.highContrastLight(),
      ColorScheme.highContrastDark(),
      // 自定义配色方案
      ColorScheme.fromSeed(seedColor: Colors.blue),
      ColorScheme.fromSeed(seedColor: Colors.green),
      ColorScheme.fromSeed(seedColor: Colors.purple),
      ColorScheme.fromSeed(seedColor: Colors.orange),
    ];
  }

  // 应用颜色主题
  Future<void> applyColorScheme(ColorScheme colorScheme) async {
    await setPrimaryColor(colorScheme.primary);
    await setAccentColor(colorScheme.secondary);
  }

  // 获取主题预览数据
  Map<String, ThemeData> getThemePreviews() {
    return {
      'current': _buildTheme(),
      ...predefinedThemes,
    };
  }

// 页码：96
// 行号：351-400
  // 检查主题是否为深色模式
  bool isDarkMode() {
    if (_themeMode.value == ThemeMode.system) {
      return WidgetsBinding.instance.window.platformBrightness == 
             Brightness.dark;
    }
    return _themeMode.value == ThemeMode.dark;
  }

  // 切换主题模式
  Future<void> toggleThemeMode() async {
    if (_themeMode.value == ThemeMode.light) {
      await setThemeMode(ThemeMode.dark);
    } else {
      await setThemeMode(ThemeMode.light);
    }
  }

  // 生成随机主题
  Future<void> generateRandomTheme() async {
    final random = Random();
    final colors = Colors.primaries;
    final primaryColor = colors[random.nextInt(colors.length)];
    final accentColor = colors[random.nextInt(colors.length)];
    final fonts = getAvailableFonts();
    final fontFamily = fonts[random.nextInt(fonts.length)];
    final fontSize = 12.0 + random.nextInt(13);

    await setPrimaryColor(primaryColor);
    await setAccentColor(accentColor);
    await setFontFamily(fontFamily);
    await setFontSize(fontSize);
  }

  @override
  void onClose() {
    _saveThemeSettings();
    super.onClose();
  }
}
```

### 7. 缓存服务（cache_service.dart）
```dart
// 页码：97
// 行号：1-50
import 'dart:convert';
import 'dart:io';
import 'package:get/get.dart';
import 'package:path_provider/path_provider.dart';
import 'package:shared_preferences.dart';
import 'package:crypto/crypto.dart';

class CacheService extends GetxService {
  static const String _keyPrefix = 'cache_';
  static const String _keyCacheSize = '${_keyPrefix}size';
  static const String _keyLastCleanup = '${_keyPrefix}last_cleanup';
  static const Duration _maxAge = Duration(days: 7);
  static const int _maxCacheSize = 100 * 1024 * 1024; // 100MB
  
  final SharedPreferences _prefs;
  late final Directory _cacheDir;
  
  // 可观察状态
  final RxInt _cacheSize = 0.obs;
  final RxBool _isCleaningUp = false.obs;
  final RxString _error = ''.obs;

  CacheService(this._prefs);

  // 初始化服务
  Future<void> init() async {
    try {
      // 获取缓存目录
      final appDir = await getApplicationDocumentsDirectory();
      _cacheDir = Directory('${appDir.path}/cache');
      
      // 创建缓存目录（如果不存在）
      if (!_cacheDir.existsSync()) {
        _cacheDir.createSync(recursive: true);
      }
      
      // 加载缓存大小
      _cacheSize.value = _prefs.getInt(_keyCacheSize) ?? 0;
      
      // 检查是否需要清理
      await _checkCleanup();
    } catch (e) {
      _error.value = '初始化缓存服务失败：$e';
    }
  }

// 页码：98
// 行号：51-100
  // 获取缓存内容
  Future<String?> getContent(String key) async {
    try {
      final file = _getCacheFile(key);
      if (!file.existsSync()) {
        return null;
      }

      final metadata = await _getMetadata(key);
      if (metadata == null) {
        return null;
      }

      // 检查是否过期
      if (_isExpired(metadata['timestamp'] as int)) {
        await _removeCache(key);
        return null;
      }

      return await file.readAsString();
    } catch (e) {
      _error.value = '获取缓存内容失败：$e';
      return null;
    }
  }

  // 缓存内容
  Future<void> cacheContent(String key, String content) async {
    try {
      final file = _getCacheFile(key);
      
      // 计算内容大小
      final contentSize = utf8.encode(content).length;
      
      // 检查缓存空间
      if (_cacheSize.value + contentSize > _maxCacheSize) {
        await cleanup();
      }
      
      // 写入内容
      await file.writeAsString(content);
      
      // 更新元数据
      await _saveMetadata(key, {
        'timestamp': DateTime.now().millisecondsSinceEpoch,
        'size': contentSize,
      });
      
      // 更新缓存大小
      _cacheSize.value += contentSize;
      await _prefs.setInt(_keyCacheSize, _cacheSize.value);
    } catch (e) {
      _error.value = '缓存内容失败：$e';
    }
  }

// 页码：99
// 行号：101-150
  // 检查是否有缓存内容
  Future<bool> hasContent() async {
    try {
      final files = _cacheDir.listSync();
      return files.isNotEmpty;
    } catch (e) {
      _error.value = '检查缓存内容失败：$e';
      return false;
    }
  }

  // 清空缓存
  Future<void> clearCache() async {
    try {
      _isCleaningUp.value = true;
      
      // 删除所有缓存文件
      if (_cacheDir.existsSync()) {
        await _cacheDir.delete(recursive: true);
        await _cacheDir.create();
      }
      
      // 重置缓存大小
      _cacheSize.value = 0;
      await _prefs.setInt(_keyCacheSize, 0);
      
      // 更新最后清理时间
      await _prefs.setInt(
        _keyLastCleanup,
        DateTime.now().millisecondsSinceEpoch,
      );
    } catch (e) {
      _error.value = '清空缓存失败：$e';
    } finally {
      _isCleaningUp.value = false;
    }
  }

  // 清理过期缓存
  Future<void> cleanup() async {
    if (_isCleaningUp.value) return;

    try {
      _isCleaningUp.value = true;
      
      final files = _cacheDir.listSync();
      var totalFreed = 0;

// 页码：100
// 行号：151-200
      for (final file in files) {
        if (file is File) {
          final key = _getKeyFromPath(file.path);
          final metadata = await _getMetadata(key);
          
          if (metadata != null) {
            final timestamp = metadata['timestamp'] as int;
            final size = metadata['size'] as int;
            
            if (_isExpired(timestamp)) {
              await _removeCache(key);
              totalFreed += size;
            }
          }
        }
      }
      
      // 更新缓存大小
      _cacheSize.value -= totalFreed;
      await _prefs.setInt(_keyCacheSize, _cacheSize.value);
      
      // 更新最后清理时间
      await _prefs.setInt(
        _keyLastCleanup,
        DateTime.now().millisecondsSinceEpoch,
      );
    } catch (e) {
      _error.value = '清理缓存失败：$e';
    } finally {
      _isCleaningUp.value = false;
    }
  }

  // 检查是否需要清理
  Future<void> _checkCleanup() async {
    final lastCleanup = _prefs.getInt(_keyLastCleanup) ?? 0;
    final now = DateTime.now().millisecondsSinceEpoch;
    
    // 如果超过7天没清理，或缓存大小超过限制，则进行清理
    if (now - lastCleanup > const Duration(days: 7).inMilliseconds ||
        _cacheSize.value > _maxCacheSize) {
      await cleanup();
    }
  }

// 页码：101
// 行号：201-250
  // 获取缓存文件
  File _getCacheFile(String key) {
    final hashedKey = _hashKey(key);
    return File('${_cacheDir.path}/$hashedKey');
  }

  // 获取元数据
  Future<Map<String, dynamic>?> _getMetadata(String key) async {
    try {
      final metadataKey = '${_keyPrefix}$key';
      final json = _prefs.getString(metadataKey);
      if (json == null) return null;
      return jsonDecode(json) as Map<String, dynamic>;
    } catch (e) {
      _error.value = '获取元数据失败：$e';
      return null;
    }
  }

  // 保存元数据
  Future<void> _saveMetadata(
    String key,
    Map<String, dynamic> metadata,
  ) async {
    try {
      final metadataKey = '${_keyPrefix}$key';
      final json = jsonEncode(metadata);
      await _prefs.setString(metadataKey, json);
    } catch (e) {
      _error.value = '保存元数据失败：$e';
    }
  }

  // 移除缓存
  Future<void> _removeCache(String key) async {
    try {
      final file = _getCacheFile(key);
      if (file.existsSync()) {
        await file.delete();
      }
      
      final metadataKey = '${_keyPrefix}$key';
      await _prefs.remove(metadataKey);
    } catch (e) {
      _error.value = '移除缓存失败：$e';
    }
  }

// 页码：102
// 行号：251-300
  // 检查是否过期
  bool _isExpired(int timestamp) {
    final age = DateTime.now().millisecondsSinceEpoch - timestamp;
    return age > _maxAge.inMilliseconds;
  }

  // 从文件路径获取键
  String _getKeyFromPath(String path) {
    return path.split('/').last;
  }

  // 生成键的哈希值
  String _hashKey(String key) {
    final bytes = utf8.encode(key);
    return sha256.convert(bytes).toString();
  }

  // 获取缓存统计信息
  Future<Map<String, dynamic>> getCacheStats() async {
    try {
      final files = _cacheDir.listSync();
      var fileCount = 0;
      var validFiles = 0;
      var expiredFiles = 0;
      
      for (final file in files) {
        if (file is File) {
          fileCount++;
          final key = _getKeyFromPath(file.path);
          final metadata = await _getMetadata(key);
          
          if (metadata != null) {
            final timestamp = metadata['timestamp'] as int;
            if (_isExpired(timestamp)) {
              expiredFiles++;
            } else {
              validFiles++;
            }
          }
        }
      }

// 页码：103
// 行号：301-350
      return {
        'totalSize': _cacheSize.value,
        'maxSize': _maxCacheSize,
        'fileCount': fileCount,
        'validFiles': validFiles,
        'expiredFiles': expiredFiles,
        'lastCleanup': _prefs.getInt(_keyLastCleanup),
        'isCleaningUp': _isCleaningUp.value,
      };
    } catch (e) {
      _error.value = '获取缓存统计信息失败：$e';
      return {};
    }
  }

  // 获取指定大小的可读字符串
  String getReadableSize(int bytes) {
    const suffixes = ['B', 'KB', 'MB', 'GB'];
    var i = 0;
    double size = bytes.toDouble();
    
    while (size >= 1024 && i < suffixes.length - 1) {
      size /= 1024;
      i++;
    }
    
    return '${size.toStringAsFixed(2)} ${suffixes[i]}';
  }

  // 导出缓存数据
  Future<Map<String, dynamic>> exportCache() async {
    try {
      final files = _cacheDir.listSync();
      final cache = <String, dynamic>{};
      
      for (final file in files) {
        if (file is File) {
          final key = _getKeyFromPath(file.path);
          final content = await file.readAsString();
          final metadata = await _getMetadata(key);
          
          cache[key] = {
            'content': content,
            'metadata': metadata,
          };
        }
      }

// 页码：104
// 行号：351-400
      return {
        'cache': cache,
        'stats': await getCacheStats(),
        'exportedAt': DateTime.now().toIso8601String(),
      };
    } catch (e) {
      _error.value = '导出缓存数据失败：$e';
      return {};
    }
  }

  // 导入缓存数据
  Future<void> importCache(Map<String, dynamic> data) async {
    try {
      await clearCache();
      
      final cache = data['cache'] as Map<String, dynamic>;
      for (final entry in cache.entries) {
        final content = entry.value['content'] as String;
        final metadata = entry.value['metadata'] as Map<String, dynamic>;
        
        await cacheContent(entry.key, content);
        await _saveMetadata(entry.key, metadata);
      }
    } catch (e) {
      _error.value = '导入缓存数据失败：$e';
    }
  }

  // 获取错误信息
  String get error => _error.value;

  // 获取缓存大小
  int get size => _cacheSize.value;

  // 是否正在清理
  bool get isCleaningUp => _isCleaningUp.value;

  @override
  void onClose() {
    _prefs.setInt(_keyCacheSize, _cacheSize.value);
    super.onClose();
  }
}
```

### 8. 小说模型（novel.dart）
```dart
// 页码：105
// 行号：1-50
import 'package:json_annotation/json_annotation.dart';

part 'novel.g.dart';

// 小说状态枚举
enum NovelStatus {
  draft,      // 草稿
  inProgress, // 生成中
  completed,  // 已完成
  published,  // 已发布
  archived,   // 已归档
}

// 小说模型
@JsonSerializable()
class Novel {
  final String title;
  final List<String> genres;
  final String theme;
  final String outline;
  final List<Chapter> chapters;
  final int totalChapters;
  final DateTime createdAt;
  final DateTime? updatedAt;
  final String? author;
  final String? description;
  final List<String>? tags;
  final NovelStatus status;
  final int? wordCount;
  final double? rating;
  final String? coverImage;
  final bool isPublished;
  final DateTime? publishedAt;

  const Novel({
    required this.title,
    required this.genres,
    required this.theme,
    required this.outline,
    required this.chapters,
    required this.totalChapters,
    required this.createdAt,
    this.updatedAt,
    this.author,
    this.description,
    this.tags,
    this.status = NovelStatus.draft,
    this.wordCount,
    this.rating,
    this.coverImage,
    this.isPublished = false,
    this.publishedAt,
  });

// 页码：106
// 行号：51-100
  // 从JSON构造
  factory Novel.fromJson(Map<String, dynamic> json) => _$NovelFromJson(json);

  // 转换为JSON
  Map<String, dynamic> toJson() => _$NovelToJson(this);

  // 复制并修改属性
  Novel copyWith({
    String? title,
    List<String>? genres,
    String? theme,
    String? outline,
    List<Chapter>? chapters,
    int? totalChapters,
    DateTime? createdAt,
    DateTime? updatedAt,
    String? author,
    String? description,
    List<String>? tags,
    NovelStatus? status,
    int? wordCount,
    double? rating,
    String? coverImage,
    bool? isPublished,
    DateTime? publishedAt,
  }) {
    return Novel(
      title: title ?? this.title,
      genres: genres ?? this.genres,
      theme: theme ?? this.theme,
      outline: outline ?? this.outline,
      chapters: chapters ?? this.chapters,
      totalChapters: totalChapters ?? this.totalChapters,
      createdAt: createdAt ?? this.createdAt,
      updatedAt: updatedAt ?? this.updatedAt,
      author: author ?? this.author,
      description: description ?? this.description,
      tags: tags ?? this.tags,
      status: status ?? this.status,
      wordCount: wordCount ?? this.wordCount,
      rating: rating ?? this.rating,
      coverImage: coverImage ?? this.coverImage,
      isPublished: isPublished ?? this.isPublished,
      publishedAt: publishedAt ?? this.publishedAt,
    );
  }

// 页码：107
// 行号：101-150
  // 计算字数
  int calculateWordCount() {
    return chapters.fold(0, (sum, chapter) {
      // 中文按字计算，英文按词计算
      final chineseCount = RegExp(r'[\u4e00-\u9fa5]')
          .allMatches(chapter.content)
          .length;
      final englishCount = RegExp(r'\b\w+\b')
          .allMatches(chapter.content)
          .length;
      return sum + chineseCount + englishCount;
    });
  }

  // 获取进度
  double getProgress() {
    if (totalChapters == 0) return 0.0;
    return chapters.length / totalChapters;
  }

  // 获取最后更新时间
  DateTime getLastUpdateTime() {
    return updatedAt ?? createdAt;
  }

  // 检查是否完整
  bool isComplete() {
    return chapters.length == totalChapters;
  }

  // 获取章节
  Chapter? getChapter(int number) {
    try {
      return chapters.firstWhere((c) => c.number == number);
    } catch (e) {
      return null;
    }
  }

  // 添加章节
  Novel addChapter(Chapter chapter) {
    final newChapters = List<Chapter>.from(chapters)..add(chapter);
    return copyWith(
      chapters: newChapters,
      updatedAt: DateTime.now(),
    );
  }

// 页码：108
// 行号：151-200
  // 更新章节
  Novel updateChapter(Chapter chapter) {
    final index = chapters.indexWhere((c) => c.number == chapter.number);
    if (index == -1) return this;

    final newChapters = List<Chapter>.from(chapters);
    newChapters[index] = chapter;

    return copyWith(
      chapters: newChapters,
      updatedAt: DateTime.now(),
    );
  }

  // 删除章节
  Novel deleteChapter(int number) {
    final newChapters = chapters.where((c) => c.number != number).toList();
    return copyWith(
      chapters: newChapters,
      updatedAt: DateTime.now(),
    );
  }

  // 发布小说
  Novel publish() {
    if (!isComplete()) throw Exception('小说未完成，无法发布');
    
    return copyWith(
      isPublished: true,
      publishedAt: DateTime.now(),
      status: NovelStatus.published,
    );
  }

  // 归档小说
  Novel archive() {
    return copyWith(
      status: NovelStatus.archived,
      updatedAt: DateTime.now(),
    );
  }

// 页码：109
// 行号：201-250
  // 获取摘要信息
  Map<String, dynamic> getSummary() {
    return {
      'title': title,
      'author': author ?? '未知作者',
      'genres': genres,
      'theme': theme,
      'wordCount': wordCount ?? calculateWordCount(),
      'chapterCount': chapters.length,
      'status': status.toString(),
      'rating': rating,
      'lastUpdated': getLastUpdateTime().toIso8601String(),
      'progress': getProgress(),
    };
  }

  // 获取元数据
  Map<String, dynamic> getMetadata() {
    return {
      'title': title,
      'author': author,
      'genres': genres,
      'theme': theme,
      'description': description,
      'tags': tags,
      'wordCount': wordCount ?? calculateWordCount(),
      'chapterCount': chapters.length,
      'totalChapters': totalChapters,
      'status': status.toString(),
      'rating': rating,
      'isPublished': isPublished,
      'createdAt': createdAt.toIso8601String(),
      'updatedAt': updatedAt?.toIso8601String(),
      'publishedAt': publishedAt?.toIso8601String(),
    };
  }

  // 验证小说数据
  bool validate() {
    if (title.isEmpty) return false;
    if (genres.isEmpty) return false;
    if (theme.isEmpty) return false;
    if (outline.isEmpty) return false;
    if (totalChapters <= 0) return false;
    
    // 验证章节
    for (final chapter in chapters) {
      if (!chapter.validate()) return false;
    }
    
    return true;
  }

// 页码：110
// 行号：251-300
  // 获取统计信息
  Map<String, dynamic> getStats() {
    final wordCount = calculateWordCount();
    final averageChapterLength = chapters.isEmpty
        ? 0
        : wordCount ~/ chapters.length;

    return {
      'totalWords': wordCount,
      'totalChapters': chapters.length,
      'averageChapterLength': averageChapterLength,
      'completionRate': getProgress(),
      'daysInProgress': DateTime.now()
          .difference(createdAt)
          .inDays,
      'isPublished': isPublished,
      'hasDescription': description != null && description!.isNotEmpty,
      'hasCover': coverImage != null && coverImage!.isNotEmpty,
      'hasTags': tags != null && tags!.isNotEmpty,
      'rating': rating,
    };
  }

  // 导出为Markdown
  String toMarkdown() {
    final buffer = StringBuffer();
    
    // 添加标题
    buffer.writeln('# $title\n');
    
    // 添加元信息
    buffer.writeln('- 作者：${author ?? "未知"}');
    buffer.writeln('- 类型：${genres.join("、")}');
    buffer.writeln('- 主题：$theme\n');
    
    // 添加简介
    if (description != null && description!.isNotEmpty) {
      buffer.writeln('## 简介\n');
      buffer.writeln(description);
      buffer.writeln();
    }

// 页码：111
// 行号：301-350
    // 添加大纲
    buffer.writeln('## 大纲\n');
    buffer.writeln(outline);
    buffer.writeln();
    
    // 添加章节内容
    for (final chapter in chapters) {
      buffer.writeln('## 第${chapter.number}章 ${chapter.title}\n');
      buffer.writeln(chapter.content);
      buffer.writeln();
    }
    
    return buffer.toString();
  }

  // 导出为EPUB元数据
  Map<String, dynamic> toEpubMetadata() {
    return {
      'title': title,
      'author': author ?? '未知',
      'description': description,
      'language': 'zh-CN',
      'genres': genres,
      'tags': tags,
      'published': publishedAt?.toIso8601String(),
      'modified': updatedAt?.toIso8601String(),
      'cover': coverImage,
      'rights': 'All rights reserved',
    };
  }

  // 生成目录
  List<Map<String, dynamic>> generateToc() {
    return chapters.map((chapter) => {
      'number': chapter.number,
      'title': chapter.title,
      'anchor': 'chapter-${chapter.number}',
    }).toList();
  }

// 页码：112
// 行号：351-400
  // 检查是否需要更新
  bool needsUpdate(Novel other) {
    if (other.chapters.length != chapters.length) return true;
    if (other.status != status) return true;
    if (other.isPublished != isPublished) return true;
    
    for (var i = 0; i < chapters.length; i++) {
      if (chapters[i].content != other.chapters[i].content) {
        return true;
      }
    }
    
    return false;
  }

  // 合并两个版本
  Novel merge(Novel other) {
    // 使用较新的基本信息
    final isOtherNewer = other.updatedAt?.isAfter(
          updatedAt ?? createdAt
        ) ?? false;
    
    // 合并章节
    final mergedChapters = <Chapter>[];
    final allNumbers = <int>{
      ...chapters.map((c) => c.number),
      ...other.chapters.map((c) => c.number),
    };
    
    for (final number in allNumbers) {
      final thisChapter = getChapter(number);
      final otherChapter = other.getChapter(number);
      
      if (thisChapter == null) {
        mergedChapters.add(otherChapter!);
      } else if (otherChapter == null) {
        mergedChapters.add(thisChapter);
      } else {
        mergedChapters.add(
          isOtherNewer ? otherChapter : thisChapter
        );
      }
    }

// 页码：113
// 行号：401-450
    return Novel(
      title: isOtherNewer ? other.title : title,
      genres: isOtherNewer ? other.genres : genres,
      theme: isOtherNewer ? other.theme : theme,
      outline: isOtherNewer ? other.outline : outline,
      chapters: mergedChapters,
      totalChapters: totalChapters,
      createdAt: createdAt,
      updatedAt: DateTime.now(),
      author: isOtherNewer ? other.author : author,
      description: isOtherNewer ? other.description : description,
      tags: isOtherNewer ? other.tags : tags,
      status: isOtherNewer ? other.status : status,
      wordCount: null, // 需要重新计算
      rating: isOtherNewer ? other.rating : rating,
      coverImage: isOtherNewer ? other.coverImage : coverImage,
      isPublished: isOtherNewer ? other.isPublished : isPublished,
      publishedAt: isOtherNewer ? other.publishedAt : publishedAt,
    );
  }

  @override
  bool operator ==(Object other) =>
      identical(this, other) ||
      other is Novel &&
          runtimeType == other.runtimeType &&
          title == other.title &&
          genres.toString() == other.genres.toString() &&
          theme == other.theme &&
          outline == other.outline &&
          chapters.toString() == other.chapters.toString() &&
          totalChapters == other.totalChapters;

// 页码：114
// 行号：451-500
  @override
  int get hashCode =>
      title.hashCode ^
      genres.hashCode ^
      theme.hashCode ^
      outline.hashCode ^
      chapters.hashCode ^
      totalChapters.hashCode;

  @override
  String toString() {
    return 'Novel{title: $title, genres: $genres, theme: $theme, '
           'chapters: ${chapters.length}/$totalChapters, '
           'status: $status}';
  }
}

// 章节模型
@JsonSerializable()
class Chapter {
  final int number;
  final String title;
  final String content;
  final DateTime? createdAt;
  final DateTime? updatedAt;

  const Chapter({
    required this.number,
    required this.title,
    required this.content,
    this.createdAt,
    this.updatedAt,
  });

  // 从JSON构造
  factory Chapter.fromJson(Map<String, dynamic> json) => 
      _$ChapterFromJson(json);

  // 转换为JSON
  Map<String, dynamic> toJson() => _$ChapterToJson(this);

// 页码：115
// 行号：501-550
  // 复制并修改属性
  Chapter copyWith({
    int? number,
    String? title,
    String? content,
    DateTime? createdAt,
    DateTime? updatedAt,
  }) {
    return Chapter(
      number: number ?? this.number,
      title: title ?? this.title,
      content: content ?? this.content,
      createdAt: createdAt ?? this.createdAt,
      updatedAt: updatedAt ?? this.updatedAt,
    );
  }

  // 计算字数
  int calculateWordCount() {
    // 中文按字计算，英文按词计算
    final chineseCount = RegExp(r'[\u4e00-\u9fa5]')
        .allMatches(content)
        .length;
    final englishCount = RegExp(r'\b\w+\b')
        .allMatches(content)
        .length;
    return chineseCount + englishCount;
  }

  // 获取摘要
  String getSummary([int maxLength = 100]) {
    if (content.length <= maxLength) {
      return content;
    }
    return '${content.substring(0, maxLength)}...';
  }

  // 验证章节数据
  bool validate() {
    if (number <= 0) return false;
    if (title.isEmpty) return false;
    if (content.isEmpty) return false;
    return true;
  }

// 页码：116
// 行号：551-600
  // 转换为Markdown
  String toMarkdown() {
    return '''
# 第$number章 $title

$content
''';
  }

  @override
  bool operator ==(Object other) =>
      identical(this, other) ||
      other is Chapter &&
          runtimeType == other.runtimeType &&
          number == other.number &&
          title == other.title &&
          content == other.content;

  @override
  int get hashCode =>
      number.hashCode ^
      title.hashCode ^
      content.hashCode;

  @override
  String toString() {
    return 'Chapter{number: $number, title: $title, '
           'wordCount: ${calculateWordCount()}}';
  }
}
```

### 9. 用户模型（user.dart）
```dart
// 页码：117
// 行号：1-50
import 'package:json_annotation/json_annotation.dart';

part 'user.g.dart';

// 用户角色枚举
enum UserRole {
  user,     // 普通用户
  vip,      // VIP用户
  admin,    // 管理员
}

// 用户状态枚举
enum UserStatus {
  active,    // 活跃
  inactive,  // 不活跃
  banned,    // 已封禁
  deleted,   // 已删除
}

// 用户模型
@JsonSerializable()
class User {
  final String id;
  final String username;
  final String email;
  final String? nickname;
  final String? avatar;
  final UserRole role;
  final UserStatus status;
  final DateTime createdAt;
  final DateTime? lastLoginAt;
  final Map<String, dynamic> preferences;
  final Map<String, dynamic> settings;
  final List<String> favoriteGenres;
  final List<String> readingHistory;
  final Map<String, int> generationQuota;
  final bool isEmailVerified;
  final bool isPremium;
  final DateTime? premiumExpiresAt;

  const User({
    required this.id,
    required this.username,
    required this.email,
    this.nickname,
    this.avatar,
    this.role = UserRole.user,
    this.status = UserStatus.active,
    required this.createdAt,
    this.lastLoginAt,
    this.preferences = const {},
    this.settings = const {},
    this.favoriteGenres = const [],
    this.readingHistory = const [],
    this.generationQuota = const {},
    this.isEmailVerified = false,
    this.isPremium = false,
    this.premiumExpiresAt,
  });

// 页码：118
// 行号：51-100
  // 从JSON构造
  factory User.fromJson(Map<String, dynamic> json) => _$UserFromJson(json);

  // 转换为JSON
  Map<String, dynamic> toJson() => _$UserToJson(this);

  // 复制并修改属性
  User copyWith({
    String? id,
    String? username,
    String? email,
    String? nickname,
    String? avatar,
    UserRole? role,
    UserStatus? status,
    DateTime? createdAt,
    DateTime? lastLoginAt,
    Map<String, dynamic>? preferences,
    Map<String, dynamic>? settings,
    List<String>? favoriteGenres,
    List<String>? readingHistory,
    Map<String, int>? generationQuota,
    bool? isEmailVerified,
    bool? isPremium,
    DateTime? premiumExpiresAt,
  }) {
    return User(
      id: id ?? this.id,
      username: username ?? this.username,
      email: email ?? this.email,
      nickname: nickname ?? this.nickname,
      avatar: avatar ?? this.avatar,
      role: role ?? this.role,
      status: status ?? this.status,
      createdAt: createdAt ?? this.createdAt,
      lastLoginAt: lastLoginAt ?? this.lastLoginAt,
      preferences: preferences ?? this.preferences,
      settings: settings ?? this.settings,
      favoriteGenres: favoriteGenres ?? this.favoriteGenres,
      readingHistory: readingHistory ?? this.readingHistory,
      generationQuota: generationQuota ?? this.generationQuota,
      isEmailVerified: isEmailVerified ?? this.isEmailVerified,
      isPremium: isPremium ?? this.isPremium,
      premiumExpiresAt: premiumExpiresAt ?? this.premiumExpiresAt,
    );
  }

// 页码：119
// 行号：101-150
  // 检查是否为管理员
  bool isAdmin() {
    return role == UserRole.admin;
  }

  // 检查是否为VIP用户
  bool isVip() {
    return role == UserRole.vip || isPremium;
  }

  // 检查账号是否有效
  bool isValid() {
    return status == UserStatus.active && !isDeleted();
  }

  // 检查账号是否已删除
  bool isDeleted() {
    return status == UserStatus.deleted;
  }

  // 检查账号是否已封禁
  bool isBanned() {
    return status == UserStatus.banned;
  }

  // 检查会员是否已过期
  bool isPremiumExpired() {
    if (!isPremium) return true;
    if (premiumExpiresAt == null) return false;
    return DateTime.now().isAfter(premiumExpiresAt!);
  }

  // 获取剩余生成配额
  int getRemainingQuota(String type) {
    return generationQuota[type] ?? 0;
  }

  // 检查是否有足够配额
  bool hasEnoughQuota(String type, int required) {
    return getRemainingQuota(type) >= required;
  }

  // 消耗生成配额
  bool consumeQuota(String type, int amount) {
    final remaining = getRemainingQuota(type);
    if (remaining < amount) return false;
    generationQuota[type] = remaining - amount;
    return true;
  }

// 页码：120
// 行号：151-200
  // 添加生成配额
  void addQuota(String type, int amount) {
    final current = getRemainingQuota(type);
    generationQuota[type] = current + amount;
  }

  // 重置生成配额
  void resetQuota(String type, int amount) {
    generationQuota[type] = amount;
  }

  // 获取用户偏好设置
  T? getPreference<T>(String key) {
    return preferences[key] as T?;
  }

  // 设置用户偏好
  void setPreference(String key, dynamic value) {
    preferences[key] = value;
  }

  // 获取用户设置
  T? getSetting<T>(String key) {
    return settings[key] as T?;
  }

  // 设置用户设置
  void setSetting(String key, dynamic value) {
    settings[key] = value;
  }

  // 添加喜好类型
  void addFavoriteGenre(String genre) {
    if (!favoriteGenres.contains(genre)) {
      favoriteGenres.add(genre);
    }
  }

  // 移除喜好类型
  void removeFavoriteGenre(String genre) {
    favoriteGenres.remove(genre);
  }

// 页码：121
// 行号：201-250
  // 添加阅读历史
  void addReadingHistory(String novelId) {
    if (!readingHistory.contains(novelId)) {
      readingHistory.add(novelId);
    }
  }

  // 清空阅读历史
  void clearReadingHistory() {
    readingHistory.clear();
  }

  // 获取用户统计信息
  Map<String, dynamic> getStats() {
    return {
      'daysRegistered': DateTime.now()
          .difference(createdAt)
          .inDays,
      'lastLoginDays': lastLoginAt != null
          ? DateTime.now().difference(lastLoginAt!).inDays
          : null,
      'favoriteGenresCount': favoriteGenres.length,
      'readingHistoryCount': readingHistory.length,
      'remainingQuota': generationQuota,
      'isPremium': isPremium,
      'premiumDaysLeft': premiumExpiresAt != null
          ? premiumExpiresAt!.difference(DateTime.now()).inDays
          : null,
    };
  }

  // 获取用户基本信息
  Map<String, dynamic> getBasicInfo() {
    return {
      'id': id,
      'username': username,
      'nickname': nickname,
      'avatar': avatar,
      'role': role.toString(),
      'status': status.toString(),
      'isEmailVerified': isEmailVerified,
      'isPremium': isPremium,
    };
  }

// 页码：122
// 行号：251-300
  // 获取用户详细信息
  Map<String, dynamic> getDetailedInfo() {
    return {
      ...getBasicInfo(),
      'email': email,
      'createdAt': createdAt.toIso8601String(),
      'lastLoginAt': lastLoginAt?.toIso8601String(),
      'preferences': preferences,
      'settings': settings,
      'favoriteGenres': favoriteGenres,
      'readingHistory': readingHistory,
      'generationQuota': generationQuota,
      'premiumExpiresAt': premiumExpiresAt?.toIso8601String(),
    };
  }

  // 验证用户数据
  bool validate() {
    if (id.isEmpty) return false;
    if (username.isEmpty) return false;
    if (email.isEmpty) return false;
    if (status == UserStatus.deleted) return false;
    return true;
  }

  // 检查是否需要更新
  bool needsUpdate(User other) {
    if (other.nickname != nickname) return true;
    if (other.avatar != avatar) return true;
    if (other.role != role) return true;
    if (other.status != status) return true;
    if (other.isPremium != isPremium) return true;
    if (other.premiumExpiresAt != premiumExpiresAt) return true;
    return false;
  }

// 页码：123
// 行号：301-350
  // 合并用户数据
  User merge(User other) {
    return User(
      id: id,
      username: username,
      email: email,
      nickname: other.nickname ?? nickname,
      avatar: other.avatar ?? avatar,
      role: other.role,
      status: other.status,
      createdAt: createdAt,
      lastLoginAt: other.lastLoginAt ?? lastLoginAt,
      preferences: {
        ...preferences,
        ...other.preferences,
      },
      settings: {
        ...settings,
        ...other.settings,
      },
      favoriteGenres: [
        ...{...favoriteGenres, ...other.favoriteGenres},
      ],
      readingHistory: [
        ...{...readingHistory, ...other.readingHistory},
      ],
      generationQuota: {
        ...generationQuota,
        ...other.generationQuota,
      },
      isEmailVerified: other.isEmailVerified,
      isPremium: other.isPremium,
      premiumExpiresAt: other.premiumExpiresAt,
    );
  }

  @override
  bool operator ==(Object other) =>
      identical(this, other) ||
      other is User &&
          runtimeType == other.runtimeType &&
          id == other.id;

// 页码：124
// 行号：351-400
  @override
  int get hashCode => id.hashCode;

  @override
  String toString() {
    return 'User{id: $id, username: $username, '
           'role: $role, status: $status}';
  }
}